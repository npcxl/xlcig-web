{"version":3,"file":"customer-service-BvTi1C1u.js","sources":["../../../../pages/customer-service.vue"],"sourcesContent":["<template>\r\n  <div class=\"min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-black\">\r\n    <!-- èƒŒæ™¯è£…é¥° -->\r\n    <div class=\"fixed inset-0 pointer-events-none\">\r\n      <div\r\n        class=\"absolute top-20 left-20 w-96 h-96 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-full filter blur-3xl animate-pulse\">\r\n      </div>\r\n      <div\r\n        class=\"absolute bottom-20 right-20 w-80 h-80 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-full filter blur-3xl animate-pulse delay-1000\">\r\n      </div>\r\n    </div>\r\n\r\n    <!-- å¯¼èˆªæ  -->\r\n    <AppHeader :show-back-button=\"false\" :show-nav-menu=\"true\" :show-breadcrumb=\"true\" :show-location=\"false\"\r\n      :show-search-button=\"false\" :show-notification-button=\"true\" :show-decorations=\"false\" current-page-title=\"åœ¨çº¿å®¢æœ\"\r\n      logo-size=\"medium\" />\r\n\r\n    <!-- é¡µé¢å¤´éƒ¨ -->\r\n    <section class=\"relative z-10\">\r\n      <div class=\"container mx-auto px-6 py-8\">\r\n        <div\r\n          class=\"glass-card-dark rounded-2xl p-8 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 animate-fade-in-up\">\r\n          <div class=\"flex items-center justify-between\">\r\n            <div>\r\n              <h1 class=\"text-4xl font-bold text-white mb-3 flex items-center gap-3\">\r\n                <i class=\"bi bi-headset text-cyan-400 text-3xl animate-bounce-gentle\"></i>\r\n                åœ¨çº¿å®¢æœ\r\n              </h1>\r\n              <p class=\"text-gray-300 text-lg\">ä¸“ä¸šçš„å®¢æœå›¢é˜Ÿéšæ—¶ä¸ºæ‚¨æä¾›å¸®åŠ©</p>\r\n            </div>\r\n            <!-- æœåŠ¡çŠ¶æ€å’Œå·¥å…· -->\r\n            <div class=\"flex items-center gap-4\">\r\n              <!-- æœåŠ¡çŠ¶æ€ -->\r\n              <div class=\"flex items-center gap-6\">\r\n                <div class=\"flex items-center gap-2\">\r\n                  <div class=\"w-3 h-3 rounded-full animate-pulse\"\r\n                    :class=\"serviceStatus.adminOnline ? 'bg-green-500' : 'bg-red-500'\"></div>\r\n                  <span class=\"text-sm text-gray-300\">\r\n                    {{ serviceStatus.adminOnline ? 'å®¢æœåœ¨çº¿' : 'æš‚æ— å®¢æœåœ¨çº¿' }}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n              <!-- å·¥å…·æŒ‰é’® -->\r\n              <div class=\"flex items-center gap-2\">\r\n                <button v-if=\"unreadCount > 0\" @click=\"markAllMessagesAsRead\"\r\n                  class=\"px-4 py-2 text-sm font-medium bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg transition-all duration-300 flex items-center gap-2 hover:scale-105 active:scale-95\">\r\n                  <i class=\"bi bi-check2-all\"></i>\r\n                  æ ‡è®°å·²è¯» ({{ unreadCount }})\r\n                </button>\r\n                <button @click=\"loadChatSessions\"\r\n                  class=\"px-4 py-2 text-sm font-medium border border-gray-600 hover:border-cyan-500 text-gray-300 hover:text-white rounded-lg transition-all duration-300 flex items-center gap-2 hover:scale-105 active:scale-95\">\r\n                  <i class=\"bi bi-arrow-clockwise\"></i>\r\n                  åˆ·æ–°\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </section>\r\n\r\n    <!-- èŠå¤©å·¥å…·æ  -->\r\n    <section class=\"relative z-10\">\r\n      <div class=\"container mx-auto px-6 py-4\">\r\n        <div\r\n          class=\"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 animate-fade-in-up\">\r\n          <div class=\"flex flex-wrap items-center justify-between gap-4\">\r\n            <div class=\"flex items-center gap-4\">\r\n              <div class=\"flex items-center gap-2\">\r\n                <i class=\"bi bi-chat-dots text-cyan-400\"></i>\r\n                <span class=\"text-white font-medium\">å½“å‰æ¨¡å¼ï¼š</span>\r\n                <span class=\"text-cyan-300\">\r\n                  {{ selectedSession ? `ä¸ ${selectedSession.user_nickname || selectedSession.user_name || 'ç”¨æˆ·'} å¯¹è¯` :\r\n                  'å®¢æœå›¢é˜Ÿæ¨¡å¼' }}\r\n                </span>\r\n              </div>\r\n              <div v-if=\"selectedSession\" class=\"flex items-center gap-2\">\r\n                <div class=\"w-2 h-2 rounded-full bg-green-500 animate-pulse\"></div>\r\n                <span class=\"text-sm text-gray-400\">ç”¨æˆ·å¯¹è¯ä¸­</span>\r\n              </div>\r\n            </div>\r\n            <div class=\"flex items-center gap-2\">\r\n              <div class=\"flex items-center gap-2 text-sm text-gray-400\">\r\n                <i class=\"bi bi-people\"></i>\r\n                <span>ä¼šè¯: {{ sessions.length }}</span>\r\n              </div>\r\n              <div class=\"flex items-center gap-2 text-sm text-gray-400\">\r\n                <i class=\"bi bi-chat-left-dots\"></i>\r\n                <span>æ¶ˆæ¯: {{ messages.length }}</span>\r\n              </div>\r\n              <div class=\"flex items-center gap-2\">\r\n                <div class=\"w-2 h-2 rounded-full animate-pulse\" :class=\"isConnected ? 'bg-green-500' : 'bg-red-500'\">\r\n                </div>\r\n                <span class=\"text-xs text-gray-400\">{{ isConnected ? 'å·²è¿æ¥' : 'è¿æ¥ä¸­...' }}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </section>\r\n\r\n    <!-- ä¸»è¦å†…å®¹åŒº -->\r\n    <main class=\"container mx-auto px-6 py-8 relative z-10\">\r\n      <!-- èŠå¤©ä¸»ä½“ -->\r\n      <div class=\"grid grid-cols-1 xl:grid-cols-4 gap-6\">\r\n        <!-- ä¼šè¯åˆ—è¡¨ -->\r\n        <div class=\"xl:col-span-1\">\r\n          <div\r\n            class=\"glass-card-dark rounded-2xl border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 overflow-hidden animate-fade-in-left h-[750px] flex flex-col\">\r\n            <!-- ä¼šè¯åˆ—è¡¨å¤´éƒ¨ -->\r\n            <div class=\"px-6 py-4 border-b border-gray-700/50 bg-gray-800/30\">\r\n              <div class=\"flex items-center justify-between\">\r\n                <div>\r\n                  <h3 class=\"text-lg font-semibold text-white mb-1 flex items-center gap-2\">\r\n                    <i class=\"bi bi-chat-left-text text-cyan-400\"></i>\r\n                    å¯¹è¯åˆ—è¡¨\r\n                  </h3>\r\n                  <p class=\"text-xs text-gray-400\">\r\n                    {{ sessions.length }} ä¸ªä¼šè¯\r\n                    <span v-if=\"selectedSession\" class=\"text-cyan-400 ml-2\">\r\n                      Â· å·²é€‰ä¸­ {{ selectedSession.user_nickname || selectedSession.user_name || `ç”¨æˆ·\r\n                      #${selectedSession.user_id}` }}\r\n                    </span>\r\n                  </p>\r\n                </div>\r\n                <div class=\"flex items-center gap-2\">\r\n                  <!-- è¿”å›å®¢æœæ¨¡å¼æŒ‰é’® -->\r\n                  <button v-if=\"selectedSession\" @click=\"backToCustomerService\"\r\n                    class=\"p-2 text-gray-400 hover:text-cyan-300 hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95\"\r\n                    title=\"è¿”å›å®¢æœæ¨¡å¼\">\r\n                    <i class=\"bi bi-arrow-left text-lg\"></i>\r\n                  </button>\r\n                  <!-- åˆ·æ–°æŒ‰é’® -->\r\n                  <button @click=\"loadChatSessions\"\r\n                    class=\"p-2 text-gray-400 hover:text-cyan-300 hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95\"\r\n                    title=\"åˆ·æ–°åˆ—è¡¨\">\r\n                    <i class=\"bi bi-arrow-clockwise text-lg\"></i>\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <!-- ä¼šè¯åˆ—è¡¨å†…å®¹ -->\r\n            <div class=\"flex-1 overflow-y-auto\">\r\n              <div v-if=\"sessions.length === 0\"\r\n                class=\"flex flex-col items-center justify-center h-full text-center p-8\">\r\n                <div\r\n                  class=\"w-20 h-20 bg-gradient-to-br from-gray-700/50 to-gray-800/50 rounded-full flex items-center justify-center mb-6\">\r\n                  <i class=\"bi bi-chat-dots text-3xl text-gray-500\"></i>\r\n                </div>\r\n                <h4 class=\"text-xl font-semibold text-white mb-3\">æš‚æ— å¯¹è¯</h4>\r\n                <p class=\"text-gray-400 text-sm leading-relaxed\">ç­‰å¾…ç”¨æˆ·å¼€å§‹å¯¹è¯<br>æˆ–ä»å®¢æœå›¢é˜Ÿæ¨¡å¼å¼€å§‹</p>\r\n              </div>\r\n\r\n              <div v-else class=\"p-4 space-y-3\">\r\n                <div v-for=\"(session, index) in sessions\" :key=\"session.id\" @click=\"selectSession(session)\"\r\n                  class=\"relative p-4 rounded-xl cursor-pointer transition-all duration-300 group hover:scale-[1.01] animate-fade-in-up border border-transparent hover:border-gray-600/50\"\r\n                  :class=\"[\r\n                    selectedSession?.id === session.id\r\n                      ? 'session-selected border-cyan-500/50'\r\n                      : 'hover:bg-gray-800/30'\r\n                  ]\" :style=\"{ animationDelay: `${index * 50}ms` }\">\r\n                  <!-- é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨ -->\r\n                  <div v-if=\"selectedSession?.id === session.id\"\r\n                    class=\"absolute top-3 left-3 w-3 h-3 bg-cyan-400 rounded-full animate-pulse shadow-lg\"></div>\r\n                  <!-- æœªè¯»æ¶ˆæ¯æŒ‡ç¤ºå™¨ -->\r\n                  <div v-if=\"session.unread_count > 0\"\r\n                    class=\"absolute top-3 right-3 min-w-[20px] h-5 bg-red-500 rounded-full flex items-center justify-center px-1\">\r\n                    <span class=\"text-xs text-white font-semibold\">{{ session.unread_count > 99 ? '99+' :\r\n                      session.unread_count }}</span>\r\n                  </div>\r\n\r\n                  <!-- ç”¨æˆ·ä¿¡æ¯ -->\r\n                  <div class=\"flex items-center space-x-4\">\r\n                    <!-- ç”¨æˆ·å¤´åƒ -->\r\n                    <div class=\"relative flex-shrink-0\">\r\n                      <div class=\"w-14 h-14 rounded-xl overflow-hidden border-2 transition-all duration-300 shadow-lg\"\r\n                        :class=\"selectedSession?.id === session.id ? 'border-cyan-400/70 shadow-cyan-400/20' : 'border-gray-700/50'\">\r\n                        <img v-if=\"session.user_avatar\" :src=\"session.user_avatar\" :alt=\"session.user_nickname || 'ç”¨æˆ·'\"\r\n                          class=\"w-full h-full object-cover\" @error=\"$event.target.style.display = 'none'\" />\r\n                        <div v-else\r\n                          class=\"w-full h-full bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center\">\r\n                          <i class=\"bi bi-person text-white text-xl\"></i>\r\n                        </div>\r\n                      </div>\r\n                      <!-- åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ -->\r\n                      <div\r\n                        class=\"absolute -bottom-1 -right-1 w-5 h-5 bg-gray-800 rounded-full flex items-center justify-center border border-gray-700\">\r\n                        <div class=\"w-3 h-3 rounded-full\" \r\n                             :class=\"session.isOnline ? 'bg-green-500 animate-pulse' : 'bg-gray-500'\"></div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <!-- ä¼šè¯ä¿¡æ¯ -->\r\n                    <div class=\"flex-1 min-w-0\">\r\n                      <div class=\"flex items-center justify-between mb-2\">\r\n                        <h4 class=\"text-white font-semibold text-base truncate\">\r\n                          {{ session.user_nickname || session.user_name || `ç”¨æˆ· #${session.user_id}` }}\r\n                        </h4>\r\n                        <span class=\"text-xs text-gray-500 flex-shrink-0 ml-2\">\r\n                          {{ formatTime(session.last_message_time || session.started_at) }}\r\n                        </span>\r\n                      </div>\r\n\r\n                      <!-- æœ€åæ¶ˆæ¯ -->\r\n                      <div class=\"mb-2\">\r\n                        <p class=\"text-sm text-gray-400 truncate leading-relaxed\">\r\n                          {{ session.last_message || 'ç­‰å¾…å¼€å§‹å¯¹è¯...' }}\r\n                        </p>\r\n                      </div>\r\n\r\n                      <!-- çŠ¶æ€ä¿¡æ¯ -->\r\n                      <div class=\"flex items-center justify-between\">\r\n                        <div class=\"flex items-center space-x-2\">\r\n                          <span class=\"text-xs px-2 py-1 rounded-lg font-medium\"\r\n                            :class=\"getSessionStatusClass(session.status)\">\r\n                            {{ getSessionStatusText(session.status) }}\r\n                          </span>\r\n                          <!-- è¯„åˆ† -->\r\n                          <div v-if=\"session.rating\" class=\"flex items-center\">\r\n                            <div class=\"flex mr-1\">\r\n                              <i v-for=\"i in 5\" :key=\"i\"\r\n                                :class=\"i <= session.rating ? 'text-yellow-400' : 'text-gray-600'\"\r\n                                class=\"bi bi-star-fill text-xs\"></i>\r\n                            </div>\r\n                            <span class=\"text-xs text-gray-500\">{{ session.rating }}.0</span>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <!-- åœ¨çº¿çŠ¶æ€ -->\r\n                        <div class=\"flex items-center gap-1\">\r\n                          <div class=\"w-2 h-2 rounded-full\" \r\n                               :class=\"session.isOnline ? 'bg-green-500 animate-pulse' : 'bg-gray-500'\"></div>\r\n                          <span class=\"text-xs\" \r\n                                :class=\"session.isOnline ? 'text-green-400' : 'text-gray-400'\">\r\n                            {{ session.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿' }}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- ä¸»èŠå¤©åŒºåŸŸ -->\r\n        <div class=\"xl:col-span-3\">\r\n          <div\r\n            class=\"glass-card-dark rounded-2xl border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 overflow-hidden animate-fade-in-right h-[750px] flex flex-col\">\r\n            <!-- èŠå¤©å¤´éƒ¨ -->\r\n            <div class=\"px-6 py-4 border-b border-gray-700/50 bg-gray-800/30\">\r\n              <div class=\"flex items-center justify-between\">\r\n                <div class=\"flex items-center gap-4\">\r\n                  <!-- èŠå¤©å¯¹è±¡å¤´åƒ -->\r\n                  <div\r\n                    class=\"w-12 h-12 rounded-xl flex items-center justify-center overflow-hidden border-2 shadow-lg transition-all duration-300\"\r\n                    :class=\"currentChatUser.isCustomerService ? 'border-cyan-500/50' : 'border-gray-600/50'\">\r\n                    <img v-if=\"currentChatUser.avatar\" :src=\"currentChatUser.avatar\" :alt=\"currentChatUser.name\"\r\n                      class=\"w-full h-full object-cover\" @error=\"handleAvatarError\" />\r\n                    <div v-else class=\"w-full h-full flex items-center justify-center animate-pulse-gentle\" :class=\"currentChatUser.isCustomerService\r\n                      ? 'bg-gradient-to-r from-cyan-500 to-blue-500'\r\n                      : 'bg-gradient-to-r from-gray-500 to-gray-600'\">\r\n                      <i class=\"text-white text-xl\"\r\n                        :class=\"currentChatUser.isCustomerService ? 'bi bi-headset' : 'bi bi-person'\"></i>\r\n                    </div>\r\n                  </div>\r\n                  <div>\r\n                    <h3 class=\"text-xl font-semibold text-white flex items-center gap-2\">\r\n                      {{ currentChatUser.name }}\r\n                      <i v-if=\"currentChatUser.isCustomerService\"\r\n                        class=\"bi bi-patch-check-fill text-cyan-400 text-lg\"></i>\r\n                    </h3>\r\n                    <p class=\"text-sm text-gray-400 flex items-center gap-2\">\r\n                    <div class=\"w-2 h-2 rounded-full\"\r\n                      :class=\"currentChatUser.isCustomerService \r\n                        ? (isConnected ? 'bg-green-500 animate-pulse' : 'bg-gray-500')\r\n                        : (currentChatUser.isOnline ? 'bg-green-500 animate-pulse' : 'bg-gray-500')\">\r\n                    </div>\r\n                    {{ currentChatUser.status }}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div class=\"flex items-center gap-3\">\r\n                  <!-- è¿æ¥çŠ¶æ€ -->\r\n                  <div class=\"flex items-center gap-2 px-3 py-1 rounded-lg bg-gray-700/30\">\r\n                    <div class=\"w-2 h-2 rounded-full animate-pulse\"\r\n                      :class=\"isConnected ? 'bg-green-500' : 'bg-red-500'\"></div>\r\n                    <span class=\"text-xs text-gray-400 font-medium\">{{ isConnected ? 'å·²è¿æ¥' : 'è¿æ¥ä¸­...' }}</span>\r\n                  </div>\r\n                  <!-- åŠŸèƒ½æŒ‰é’® -->\r\n                  <div class=\"flex items-center gap-1\">\r\n                    <button\r\n                      class=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95\"\r\n                      title=\"è¯­éŸ³é€šè¯\">\r\n                      <i class=\"bi bi-telephone text-lg\"></i>\r\n                    </button>\r\n                    <button\r\n                      class=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95\"\r\n                      title=\"æ›´å¤šé€‰é¡¹\">\r\n                      <i class=\"bi bi-three-dots text-lg\"></i>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->\r\n            <div class=\"flex-1 overflow-y-auto p-6\" ref=\"messagesContainer\">\r\n              <!-- æ¬¢è¿æ¶ˆæ¯ -->\r\n              <div v-if=\"messages.length === 0\" class=\"text-center py-16\">\r\n                <div\r\n                  class=\"w-24 h-24 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-2xl\">\r\n                  <i class=\"bi bi-chat-heart text-4xl text-cyan-400\"></i>\r\n                </div>\r\n                <h3 class=\"text-2xl font-bold text-white mb-3\">\r\n                  {{ selectedSession ? `ä¸ ${selectedSession.user_nickname || selectedSession.user_name || `ç”¨æˆ·\r\n                  #${selectedSession.user_id}`} çš„å¯¹è¯` : 'æ¬¢è¿ä½¿ç”¨åœ¨çº¿å®¢æœ' }}\r\n                </h3>\r\n                <p class=\"text-gray-400 mb-8 text-lg leading-relaxed max-w-md mx-auto\">\r\n                  {{ selectedSession ? 'æ‚¨æ­£åœ¨ä¸è¯¥ç”¨æˆ·è¿›è¡Œç§äººå¯¹è¯ï¼Œå¯ä»¥å®æ—¶äº¤æµè§£å†³é—®é¢˜' : 'æœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥åœ¨è¿™é‡Œä¸æˆ‘ä»¬æ²Ÿé€šï¼Œæ‚¨ä¹Ÿå¯ä»¥ä»å·¦ä¾§é€‰æ‹©ç‰¹å®šç”¨æˆ·è¿›è¡Œå¯¹è¯' }}\r\n                </p>\r\n                <div class=\"flex flex-wrap justify-center gap-3 max-w-2xl mx-auto\">\r\n                  <button v-for=\"(quickMsg, index) in quickMessages\" :key=\"quickMsg\" @click=\"sendQuickMessage(quickMsg)\"\r\n                    class=\"px-6 py-3 bg-cyan-500/20 border border-cyan-400/30 text-cyan-300 rounded-xl text-sm font-medium hover:bg-cyan-500/30 hover:border-cyan-400/50 transition-all duration-300 hover:scale-105 active:scale-95 animate-fade-in-up shadow-lg hover:shadow-cyan-400/20\"\r\n                    :style=\"{ animationDelay: `${index * 100}ms` }\">\r\n                    {{ quickMsg }}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- ç³»ç»Ÿæç¤º -->\r\n              <div v-if=\"!serviceStatus.adminOnline && messages.length > 0\" class=\"mb-6 animate-fade-in-up\">\r\n                <div\r\n                  class=\"bg-yellow-500/10 border border-yellow-400/30 rounded-lg p-4 text-center transition-all duration-300 hover:bg-yellow-500/15 hover:border-yellow-400/50\">\r\n                  <i class=\"bi bi-info-circle text-yellow-400 mr-2 animate-pulse\"></i>\r\n                  <span class=\"text-yellow-300 text-sm\">å½“å‰æš‚æ— å®¢æœåœ¨çº¿ï¼Œæ‚¨å¯ä»¥ç•™è¨€ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤æ‚¨ã€‚</span>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->\r\n              <div class=\"space-y-4\">\r\n                <TransitionGroup name=\"message\" tag=\"div\" class=\"space-y-4\">\r\n                  <div v-for=\"message in messages\" :key=\"message.id || message.timestamp\" class=\"flex\"\r\n                    :class=\"isCurrentUserMessage(message) ? 'justify-end' : 'justify-start'\">\r\n\r\n                    <!-- å…¶ä»–äººçš„æ¶ˆæ¯ (å·¦è¾¹) - åŒ…æ‹¬å®¢æœ -->\r\n                    <div v-if=\"!isCurrentUserMessage(message)\" class=\"flex items-start gap-3 max-w-[70%]\">\r\n                      <!-- å‘é€è€…å¤´åƒ -->\r\n                      <div\r\n                        class=\"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden border border-gray-600/30\">\r\n                        <img v-if=\"getMessageAvatar(message)\" :src=\"getMessageAvatar(message)\"\r\n                          :alt=\"getMessageNickname(message)\" class=\"w-full h-full object-cover\"\r\n                          @error=\"handleAvatarError\" @load=\"handleAvatarLoad\" />\r\n                        <div v-else class=\"w-full h-full rounded-full flex items-center justify-center\"\r\n                          :class=\"isCustomerServiceMessage(message) ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-gradient-to-r from-gray-500 to-gray-600'\">\r\n                          <i class=\"text-white text-sm\"\r\n                            :class=\"isCustomerServiceMessage(message) ? 'bi bi-person-badge' : 'bi bi-person'\"></i>\r\n                        </div>\r\n                      </div>\r\n                      <div>\r\n                        <div class=\"bg-gray-700/50 border border-gray-600/30 rounded-2xl rounded-tl-sm p-3 text-white\">\r\n                          {{ message.message || message.data?.message }}\r\n                        </div>\r\n                        <div class=\"flex items-center gap-2 mt-1 ml-1\">\r\n                          <span class=\"text-xs\"\r\n                            :class=\"isCustomerServiceMessage(message) ? 'text-green-400' : 'text-gray-400'\">\r\n                            {{ message.nickname || message.data?.nickname || (isCustomerServiceMessage(message) ? 'å®¢æœ' :\r\n                            'ç”¨æˆ·') }}\r\n                          </span>\r\n                          <span class=\"text-xs text-gray-500\">{{ formatTime(message.timestamp || message.created_at)\r\n                            }}</span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <!-- å½“å‰ç”¨æˆ·æ¶ˆæ¯ (å³è¾¹) -->\r\n                    <div v-else class=\"flex items-start gap-3 max-w-[70%] flex-row-reverse\">\r\n                      <!-- ç”¨æˆ·å¤´åƒ -->\r\n                      <div\r\n                        class=\"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden border border-cyan-500/30\">\r\n                        <img v-if=\"getUserAvatar(message)\" :src=\"getUserAvatar(message)\" :alt=\"getUserNickname(message)\"\r\n                          class=\"w-full h-full object-cover\" @error=\"handleAvatarError\" @load=\"handleAvatarLoad\" />\r\n                        <div v-else\r\n                          class=\"w-full h-full bg-gradient-to-r from-cyan-600 to-blue-600 rounded-full flex items-center justify-center\">\r\n                          <i class=\"bi bi-person text-white text-sm\"></i>\r\n                        </div>\r\n                      </div>\r\n                      <div class=\"text-right\">\r\n                        <div\r\n                          class=\"bg-gradient-to-r from-cyan-600 to-blue-600 rounded-2xl rounded-tr-sm p-3 text-white\">\r\n                          {{ message.message || message.data?.message }}\r\n                        </div>\r\n                        <div class=\"flex items-center gap-2 mt-1 justify-end mr-1\">\r\n                          <span class=\"text-xs text-gray-500\">{{ formatTime(message.timestamp || message.created_at)\r\n                            }}</span>\r\n                          <span class=\"text-xs text-cyan-400\">\r\n                            {{ getUserNickname(message) }}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                </TransitionGroup>\r\n\r\n                <!-- æ­£åœ¨è¾“å…¥æç¤º -->\r\n                <div v-if=\"isTyping && typingUsers.size > 0\" class=\"flex justify-start mt-4\">\r\n                  <div v-for=\"[userId, userInfo] in typingUsers\" :key=\"userId\" class=\"flex items-start gap-3 max-w-[70%] animate-fade-in-up mb-2\">\r\n                    <!-- ç”¨æˆ·å¤´åƒ -->\r\n                    <div class=\"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden border border-gray-600/30\">\r\n                      <img \r\n                        v-if=\"userInfo.avatar\" \r\n                        :src=\"userInfo.avatar\" \r\n                        :alt=\"userInfo.nickname\"\r\n                        class=\"w-full h-full object-cover\"\r\n                        @error=\"$event.target.style.display = 'none'\"\r\n                      />\r\n                      <div \r\n                        v-else\r\n                        class=\"w-full h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center animate-pulse-gentle\">\r\n                        <i class=\"bi bi-person-badge text-white text-sm\"></i>\r\n                      </div>\r\n                    </div>\r\n                    \r\n                    <div>\r\n                      <div class=\"bg-gray-700/50 border border-gray-600/30 rounded-2xl rounded-tl-sm p-3\">\r\n                        <div class=\"flex gap-1\">\r\n                          <div class=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\"></div>\r\n                          <div class=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style=\"animation-delay: 0.1s\"></div>\r\n                          <div class=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style=\"animation-delay: 0.2s\"></div>\r\n                        </div>\r\n                      </div>\r\n                      <div class=\"flex items-center gap-2 mt-1 ml-1\">\r\n                        <span class=\"text-xs text-green-400\">{{ userInfo.nickname }}</span>\r\n                        <span class=\"text-xs text-gray-500\">æ­£åœ¨è¾“å…¥...</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->\r\n            <div class=\"px-6 py-4 border-t border-gray-700/50 bg-gray-800/20\">\r\n              <!-- å·¥å…·æŒ‰é’®ç»„ -->\r\n              <div class=\"flex items-center justify-between mb-3\">\r\n                <div class=\"flex items-center gap-2\">\r\n                  <button\r\n                    class=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95\"\r\n                    title=\"é™„ä»¶\">\r\n                    <i class=\"bi bi-paperclip text-lg\"></i>\r\n                  </button>\r\n                  <button\r\n                    class=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95\"\r\n                    title=\"è¡¨æƒ…\">\r\n                    <i class=\"bi bi-emoji-smile text-lg\"></i>\r\n                  </button>\r\n                </div>\r\n                \r\n                <!-- è¾“å…¥æç¤ºå·¥å…·æ  -->\r\n                <div class=\"flex items-center gap-3\">\r\n                  <span class=\"text-xs text-gray-500 flex items-center gap-1\">\r\n                    <i class=\"bi bi-keyboard\"></i>\r\n                    Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ\r\n                  </span>\r\n                  <div v-if=\"newMessage.length > 0\" class=\"text-xs text-gray-500\">\r\n                    {{ newMessage.length }} å­—ç¬¦\r\n                  </div>\r\n                  <button v-if=\"unreadCount > 0\" @click=\"markAllMessagesAsRead\"\r\n                    class=\"text-xs text-cyan-400 hover:text-cyan-300 transition-all duration-300 hover:scale-105 active:scale-95 px-3 py-1 rounded-lg hover:bg-cyan-500/10 border border-cyan-500/20\">\r\n                    <i class=\"bi bi-check2-all mr-1\"></i>\r\n                    æ ‡è®°å·²è¯» ({{ unreadCount }})\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              <!-- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’® -->\r\n              <div class=\"flex items-end gap-3\">\r\n                <!-- è¾“å…¥æ¡†åŒºåŸŸ -->\r\n                <div class=\"flex-1 relative\">\r\n                  <textarea v-model=\"newMessage\" @keydown.enter.exact.prevent=\"sendMessage\"\r\n                    @input=\"adjustTextareaHeight\" @focus=\"handleInputFocus\" @blur=\"handleInputBlur\"\r\n                    :disabled=\"!isConnected\" placeholder=\"è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)\" rows=\"1\"\r\n                    class=\"w-full px-4 py-3 bg-gray-800/50 border border-gray-600/50 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-400 text-white placeholder-gray-400 transition-all duration-300 resize-none hover:border-cyan-500/50 focus:scale-[1.01] min-h-[48px] max-h-32 hide-scrollbar\"></textarea>\r\n                  <!-- è¾“å…¥çŠ¶æ€æŒ‡ç¤º -->\r\n                  <div v-if=\"isInputFocused\"\r\n                    class=\"absolute -top-6 left-2 text-xs text-cyan-400 bg-gray-800/80 px-2 py-1 rounded-lg\">\r\n                    æ­£åœ¨è¾“å…¥...\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- å‘é€æŒ‰é’® -->\r\n                <button @click=\"sendMessage\" :disabled=\"!newMessage.trim() || !isConnected\"\r\n                  class=\"px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-gray-600 disabled:to-gray-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 disabled:shadow-none flex items-center gap-2 hover:scale-105 active:scale-95 min-h-[48px] flex-shrink-0\">\r\n                  <i class=\"bi bi-send text-lg\"></i>\r\n                  <span class=\"hidden sm:inline\">å‘é€</span>\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n\r\n    </main>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, computed, onMounted, onUnmounted, nextTick, watch } from 'vue'\r\nimport { useUserStore } from '~/stores/user'\r\nimport { ChatApi } from '~/utils/api/chat'\r\n\r\n// è·å–è¿è¡Œæ—¶é…ç½®\r\nconst config = useRuntimeConfig()\r\n\r\n// çŠ¶æ€ç®¡ç†\r\nconst userStore = useUserStore()\r\nconst isConnected = ref(false)\r\nconst isTyping = ref(false)\r\nconst typingUsers = ref(new Map()) // å­˜å‚¨æ­£åœ¨è¾“å…¥çš„ç”¨æˆ·ï¼Œæ ¼å¼ï¼šuserId -> { nickname, avatar, timestamp }\r\nconst unreadCount = ref(0)\r\nconst newMessage = ref('')\r\nconst messages = ref([])\r\nconst sessions = ref([])\r\nconst messagesContainer = ref()\r\nconst selectedSession = ref(null) // å½“å‰é€‰ä¸­çš„ä¼šè¯\r\n\r\n// æœåŠ¡çŠ¶æ€\r\nconst serviceStatus = ref({\r\n  adminOnline: false,\r\n  adminCount: 0,\r\n  totalUsers: 0,\r\n  normalUserCount: 0\r\n})\r\n\r\n// WebSocketè¿æ¥\r\nlet websocket = null\r\nlet heartbeatTimer = null\r\n\r\n// å¿«é€Ÿæ¶ˆæ¯\r\nconst quickMessages = [\r\n  'ä½ å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ',\r\n  'æˆ‘æƒ³äº†è§£äº§å“ä¿¡æ¯',\r\n  'è®¢å•ç›¸å…³é—®é¢˜',\r\n  'æŠ€æœ¯æ”¯æŒ'\r\n]\r\n\r\n// è®¡ç®—å±æ€§\r\nconst isLoggedIn = computed(() => userStore.isLoggedIn)\r\n\r\n// å½“å‰èŠå¤©å¯¹è±¡ä¿¡æ¯\r\nconst currentChatUser = computed(() => {\r\n  if (!selectedSession.value) {\r\n    return {\r\n      name: 'xlCig å®¢æœå›¢é˜Ÿ',\r\n      avatar: null,\r\n      status: serviceStatus.value.adminOnline ? 'åœ¨çº¿ - å¹³å‡å“åº”æ—¶é—´ < 1åˆ†é’Ÿ' : 'ç¦»çº¿ - æˆ‘ä»¬ä¼šå°½å¿«å›å¤æ‚¨çš„æ¶ˆæ¯',\r\n      isCustomerService: true\r\n    }\r\n  }\r\n\r\n  return {\r\n    name: selectedSession.value.displayName || selectedSession.value.user_nickname || selectedSession.value.user_name || `ç”¨æˆ· #${selectedSession.value.user_id}`,\r\n    avatar: selectedSession.value.avatar || selectedSession.value.user_avatar,\r\n    status: selectedSession.value.isOnline ? 'åœ¨çº¿ - ç”¨æˆ·å¯¹è¯' : 'ç¦»çº¿ - ç”¨æˆ·å¯¹è¯',\r\n    isCustomerService: false,\r\n    isOnline: selectedSession.value.isOnline,\r\n    userId: selectedSession.value.user_id,\r\n    sessionId: selectedSession.value.id\r\n  }\r\n})\r\n\r\n// é¡µé¢å…ƒæ•°æ®\r\nuseHead({\r\n  title: 'åœ¨çº¿å®¢æœ - xlCig',\r\n  meta: [\r\n    { name: 'description', content: 'ä¸“ä¸šçš„åœ¨çº¿å®¢æœæœåŠ¡ï¼Œä¸ºæ‚¨æä¾›å®æ—¶å¸®åŠ©å’Œæ”¯æŒ' }\r\n  ]\r\n})\r\n\r\n// WebSocketè¿æ¥\r\nconst connectWebSocket = () => {\r\n  if (!isLoggedIn.value || !userStore.token) {\r\n    console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è¿æ¥WebSocket')\r\n    return\r\n  }\r\n\r\n  try {\r\n    const wsUrl = `wss://api.xlcig.cn/websocket?token=${userStore.token}`\r\n    console.log('æ­£åœ¨è¿æ¥WebSocket:', wsUrl)\r\n\r\n    websocket = new WebSocket(wsUrl)\r\n\r\n    websocket.onopen = () => {\r\n      console.log('WebSocketè¿æ¥æˆåŠŸ')\r\n      isConnected.value = true\r\n      startHeartbeat()\r\n      \r\n      // è¿æ¥æˆåŠŸåï¼Œè¯·æ±‚è·å–å½“å‰æ‰€æœ‰ç”¨æˆ·çš„åœ¨çº¿çŠ¶æ€\r\n      setTimeout(() => {\r\n        if (websocket && websocket.readyState === WebSocket.OPEN) {\r\n          websocket.send(JSON.stringify({ \r\n            type: 'get_users_status',\r\n            data: {}\r\n          }))\r\n          console.log('å·²è¯·æ±‚è·å–ç”¨æˆ·åœ¨çº¿çŠ¶æ€')\r\n        }\r\n      }, 1000)\r\n    }\r\n\r\n    websocket.onmessage = (event) => {\r\n      try {\r\n        const message = JSON.parse(event.data)\r\n        handleWebSocketMessage(message)\r\n      } catch (error) {\r\n        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error)\r\n      }\r\n    }\r\n\r\n    websocket.onclose = () => {\r\n      console.log('WebSocketè¿æ¥å…³é—­')\r\n      isConnected.value = false\r\n      stopHeartbeat()\r\n\r\n      // è‡ªåŠ¨é‡è¿\r\n      setTimeout(() => {\r\n        console.log('å°è¯•é‡æ–°è¿æ¥WebSocket...')\r\n        connectWebSocket()\r\n      }, 3000)\r\n    }\r\n\r\n    websocket.onerror = (error) => {\r\n      console.error('WebSocketè¿æ¥é”™è¯¯:', error)\r\n      isConnected.value = false\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('åˆ›å»ºWebSocketè¿æ¥å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\nconst disconnectWebSocket = () => {\r\n  if (websocket) {\r\n    websocket.close()\r\n    websocket = null\r\n  }\r\n  stopHeartbeat()\r\n  isConnected.value = false\r\n}\r\n\r\n// å¿ƒè·³æœºåˆ¶\r\nconst startHeartbeat = () => {\r\n  heartbeatTimer = setInterval(() => {\r\n    if (websocket && websocket.readyState === WebSocket.OPEN) {\r\n      websocket.send(JSON.stringify({ type: 'ping' }))\r\n    }\r\n  }, 30000)\r\n}\r\n\r\nconst stopHeartbeat = () => {\r\n  if (heartbeatTimer) {\r\n    clearInterval(heartbeatTimer)\r\n    heartbeatTimer = null\r\n  }\r\n}\r\n\r\n// å¤„ç†WebSocketæ¶ˆæ¯\r\nconst handleWebSocketMessage = (message) => {\r\n  console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', message)\r\n\r\n  switch (message.type) {\r\n    case 'user_info':\r\n      console.log('ç”¨æˆ·ä¿¡æ¯:', message.data)\r\n      unreadCount.value = message.data.unreadCount || 0\r\n      if (message.data.stats) {\r\n        serviceStatus.value = message.data.stats\r\n      }\r\n      break\r\n\r\n    case 'message':\r\n      // ç¡®ä¿åŒ…å«å¤´åƒå’Œæ˜µç§°ä¿¡æ¯ï¼Œå¹¶æ­£ç¡®è¯†åˆ«æ¶ˆæ¯ç±»å‹\r\n      const isCustomerServiceMsg = message.isAdmin || message.data?.isAdmin || message.data?.isCustomerService || message.data?.role === 'admin' || message.data?.role === 'customer_service'\r\n\r\n      const messageWithUserInfo = {\r\n        ...message,\r\n        user_id: message.user_id || message.data?.user_id || message.data?.userId,\r\n        avatar: message.avatar || message.data?.avatar,\r\n        nickname: message.nickname || message.data?.nickname || message.data?.userName,\r\n        userName: message.userName || message.data?.userName,\r\n        // æ£€æŸ¥æ˜¯å¦ä¸ºå®¢æœæ¶ˆæ¯\r\n        isAdmin: isCustomerServiceMsg,\r\n        message_type: message.message_type || (isCustomerServiceMsg ? 'customer_service' : 'user'),\r\n        // å¯¹äºå®¢æœæ¶ˆæ¯ï¼Œæ·»åŠ å‘é€è€…IDä¿¡æ¯\r\n        ...(isCustomerServiceMsg && {\r\n          senderId: message.data?.userId || message.userId || message.data?.senderId,\r\n          data: {\r\n            ...message.data,\r\n            userId: message.data?.userId || message.userId,\r\n            senderId: message.data?.senderId || message.data?.userId\r\n          }\r\n        })\r\n      }\r\n\r\n      console.log('å¤„ç†åçš„æ¶ˆæ¯:', messageWithUserInfo)\r\n\r\n      // å¦‚æœé€‰ä¸­äº†ç‰¹å®šç”¨æˆ·ï¼Œåªæ˜¾ç¤ºè¯¥ç”¨æˆ·ç›¸å…³çš„æ¶ˆæ¯\r\n      if (selectedSession.value) {\r\n        const messageUserId = messageWithUserInfo.user_id || messageWithUserInfo.data?.targetUserId\r\n        if (messageUserId === selectedSession.value.user_id) {\r\n          messages.value.push(messageWithUserInfo)\r\n          scrollToBottom()\r\n        } else {\r\n          console.log('æ¶ˆæ¯ä¸å±äºå½“å‰é€‰ä¸­ç”¨æˆ·ï¼Œä¸æ˜¾ç¤º:', messageUserId, 'å½“å‰ç”¨æˆ·:', selectedSession.value.user_id)\r\n        }\r\n      } else {\r\n        // æœªé€‰ä¸­ç‰¹å®šç”¨æˆ·ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ï¼ˆé»˜è®¤å®¢æœæ¨¡å¼ï¼‰\r\n        messages.value.push(messageWithUserInfo)\r\n        scrollToBottom()\r\n      }\r\n\r\n      // å½“æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ ‡è®°ä¸ºå·²è¯»\r\n      nextTick(() => {\r\n        autoMarkAsRead()\r\n      })\r\n\r\n      // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„æœªè¯»æ•°é‡å’Œæœ€åæ¶ˆæ¯\r\n      if (messageWithUserInfo.user_id) {\r\n        updateSessionList(messageWithUserInfo)\r\n      }\r\n      break\r\n\r\n    case 'typing':\r\n      console.log('æ”¶åˆ°è¾“å…¥çŠ¶æ€æ¶ˆæ¯:', message.data)\r\n      handleTypingMessage(message.data, true)\r\n      break\r\n\r\n    case 'stop_typing':\r\n      console.log('æ”¶åˆ°åœæ­¢è¾“å…¥æ¶ˆæ¯:', message.data)\r\n      handleTypingMessage(message.data, false)\r\n      break\r\n\r\n    case 'message_read':\r\n      unreadCount.value = message.data.unreadCount || 0\r\n      break\r\n\r\n    case 'user_online':\r\n      console.log('ç”¨æˆ·ä¸Šçº¿:', message.data)\r\n      updateUserOnlineStatus(message.data.userId || message.data.user_id, true, message.data)\r\n      break\r\n\r\n    case 'user_offline':\r\n      console.log('ç”¨æˆ·ä¸‹çº¿:', message.data)\r\n      updateUserOnlineStatus(message.data.userId || message.data.user_id, false, message.data)\r\n      break\r\n\r\n    case 'user_status_update':\r\n      console.log('ç”¨æˆ·çŠ¶æ€æ›´æ–°:', message.data)\r\n      if (message.data && (message.data.userId || message.data.user_id)) {\r\n        const isOnline = message.data.isOnline !== undefined ? message.data.isOnline : true\r\n        updateUserOnlineStatus(message.data.userId || message.data.user_id, isOnline, message.data)\r\n      }\r\n      break\r\n\r\n    case 'users_status_response':\r\n      console.log('æ”¶åˆ°ç”¨æˆ·çŠ¶æ€åˆ—è¡¨:', message.data)\r\n      if (message.data && Array.isArray(message.data.users)) {\r\n        message.data.users.forEach(user => {\r\n          updateUserOnlineStatus(user.userId || user.user_id, user.isOnline, user)\r\n        })\r\n      }\r\n      break\r\n\r\n    case 'error':\r\n      console.error('WebSocketé”™è¯¯:', message.data)\r\n      break\r\n  }\r\n}\r\n\r\n// æ¸…é™¤æ‰€æœ‰typingçŠ¶æ€\r\nconst clearTypingStates = () => {\r\n  typingUsers.value.clear()\r\n  isTyping.value = false\r\n  console.log('å·²æ¸…é™¤æ‰€æœ‰typingçŠ¶æ€')\r\n}\r\n\r\n// å¤„ç†è¾“å…¥çŠ¶æ€æ¶ˆæ¯\r\nconst handleTypingMessage = (data, isTyping) => {\r\n  const userId = data.userId || data.user_id || data.senderId\r\n  const targetUserId = data.targetUserId || data.target_user_id\r\n  \r\n  console.log('å¤„ç†è¾“å…¥çŠ¶æ€:', { userId, targetUserId, isTyping, currentSession: selectedSession.value?.user_id })\r\n  \r\n  // å¦‚æœæ˜¯åœ¨ç‰¹å®šç”¨æˆ·å¯¹è¯æ¨¡å¼ä¸‹\r\n  if (selectedSession.value) {\r\n    // åªæœ‰å½“å‰é€‰ä¸­ç”¨æˆ·æˆ–è€…ç›®æ ‡ç”¨æˆ·æ˜¯å½“å‰é€‰ä¸­ç”¨æˆ·æ—¶ï¼Œæ‰æ˜¾ç¤ºtypingçŠ¶æ€\r\n    const isCurrentSessionUser = userId === selectedSession.value.user_id || targetUserId === selectedSession.value.user_id\r\n    \r\n    if (isCurrentSessionUser) {\r\n      if (isTyping) {\r\n        // æ·»åŠ /æ›´æ–°æ­£åœ¨è¾“å…¥çš„ç”¨æˆ·\r\n        typingUsers.value.set(userId, {\r\n          nickname: data.nickname || data.userName || 'ç”¨æˆ·',\r\n          avatar: data.avatar,\r\n          timestamp: Date.now()\r\n        })\r\n        isTyping.value = true\r\n        console.log(`ç”¨æˆ· ${userId} å¼€å§‹è¾“å…¥`)\r\n      } else {\r\n        // ç§»é™¤æ­£åœ¨è¾“å…¥çš„ç”¨æˆ·\r\n        typingUsers.value.delete(userId)\r\n        isTyping.value = typingUsers.value.size > 0\r\n        console.log(`ç”¨æˆ· ${userId} åœæ­¢è¾“å…¥`)\r\n      }\r\n    }\r\n  } else {\r\n    // å®¢æœå›¢é˜Ÿæ¨¡å¼ä¸‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¾“å…¥çŠ¶æ€\r\n    if (isTyping) {\r\n      typingUsers.value.set(userId, {\r\n        nickname: data.nickname || data.userName || 'ç”¨æˆ·',\r\n        avatar: data.avatar,\r\n        timestamp: Date.now()\r\n      })\r\n      isTyping.value = true\r\n      console.log(`ç”¨æˆ· ${userId} å¼€å§‹è¾“å…¥ï¼ˆå›¢é˜Ÿæ¨¡å¼ï¼‰`)\r\n    } else {\r\n      typingUsers.value.delete(userId)\r\n      isTyping.value = typingUsers.value.size > 0\r\n      console.log(`ç”¨æˆ· ${userId} åœæ­¢è¾“å…¥ï¼ˆå›¢é˜Ÿæ¨¡å¼ï¼‰`)\r\n    }\r\n  }\r\n}\r\n\r\n// æ›´æ–°ç”¨æˆ·åœ¨çº¿çŠ¶æ€\r\nconst updateUserOnlineStatus = (userId, isOnline, userData = {}) => {\r\n  if (!userId) return\r\n  \r\n  console.log(`æ›´æ–°ç”¨æˆ· ${userId} åœ¨çº¿çŠ¶æ€:`, isOnline, userData)\r\n  \r\n  // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„ç”¨æˆ·çŠ¶æ€\r\n  const sessionIndex = sessions.value.findIndex(session => session.user_id === userId)\r\n  if (sessionIndex >= 0) {\r\n    const session = sessions.value[sessionIndex]\r\n    const previousStatus = session.isOnline\r\n    \r\n    // æ›´æ–°åœ¨çº¿çŠ¶æ€\r\n    session.isOnline = isOnline\r\n    \r\n    // å¦‚æœæœ‰æ–°çš„ç”¨æˆ·æ•°æ®ï¼Œæ›´æ–°ç›¸å…³ä¿¡æ¯\r\n    if (userData.userName && userData.userName !== session.user_name) {\r\n      session.user_name = userData.userName\r\n      session.displayName = userData.userName\r\n    }\r\n    if (userData.nickname && userData.nickname !== session.user_nickname) {\r\n      session.user_nickname = userData.nickname\r\n      session.displayName = userData.nickname\r\n    }\r\n    if (userData.avatar && userData.avatar !== session.avatar) {\r\n      session.avatar = userData.avatar\r\n      session.user_avatar = userData.avatar\r\n    }\r\n    \r\n    // çŠ¶æ€å˜åŒ–æç¤º\r\n    if (previousStatus !== isOnline) {\r\n      const userName = session.displayName || session.user_nickname || session.user_name || `ç”¨æˆ· #${userId}`\r\n      console.log(`ğŸ“± ${userName} ${isOnline ? 'ğŸŸ¢ ä¸Šçº¿äº†' : 'ğŸ”´ ä¸‹çº¿äº†'}`)\r\n      \r\n      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ Toastæç¤ºæˆ–å…¶ä»–è§†è§‰åé¦ˆ\r\n      // ä¾‹å¦‚ï¼šshowToast(`${userName} ${isOnline ? 'ä¸Šçº¿äº†' : 'ä¸‹çº¿äº†'}`)\r\n    }\r\n    \r\n    console.log(`ä¼šè¯åˆ—è¡¨ä¸­ç”¨æˆ· ${userId} çŠ¶æ€å·²æ›´æ–°:`, session)\r\n  } else {\r\n    // å¦‚æœä¼šè¯åˆ—è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œä¸”ç”¨æˆ·ä¸Šçº¿äº†ï¼Œå¯ä»¥è€ƒè™‘é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨\r\n    if (isOnline) {\r\n      console.log(`æ–°ç”¨æˆ· ${userId} ä¸Šçº¿ï¼Œé‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨`)\r\n      loadChatSessions()\r\n    }\r\n  }\r\n  \r\n  // å¦‚æœå½“å‰é€‰ä¸­çš„ç”¨æˆ·çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘è®¡ç®—å±æ€§æ›´æ–°\r\n  if (selectedSession.value && selectedSession.value.user_id === userId) {\r\n    selectedSession.value.isOnline = isOnline\r\n    \r\n    // æ›´æ–°é€‰ä¸­ç”¨æˆ·çš„å…¶ä»–ä¿¡æ¯\r\n    if (userData.userName) selectedSession.value.user_name = userData.userName\r\n    if (userData.nickname) selectedSession.value.user_nickname = userData.nickname\r\n    if (userData.avatar) {\r\n      selectedSession.value.avatar = userData.avatar\r\n      selectedSession.value.user_avatar = userData.avatar\r\n    }\r\n    \r\n    console.log(`å½“å‰é€‰ä¸­ç”¨æˆ· ${userId} çŠ¶æ€å·²æ›´æ–°`, selectedSession.value)\r\n  }\r\n}\r\n\r\n// è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦\r\nconst adjustTextareaHeight = (event) => {\r\n  const textarea = event.target\r\n  textarea.style.height = 'auto'\r\n  textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px' // æœ€å¤§é«˜åº¦128px\r\n}\r\n\r\n// å‘é€æ¶ˆæ¯\r\nconst sendMessage = async () => {\r\n  if (!newMessage.value.trim()) {\r\n    return\r\n  }\r\n\r\n  const messageText = newMessage.value.trim()\r\n\r\n  try {\r\n    if (selectedSession.value) {\r\n      // é€‰ä¸­äº†ç‰¹å®šç”¨æˆ·ï¼Œä½¿ç”¨APIå‘é€æ¶ˆæ¯\r\n      console.log('å‘ç”¨æˆ·å‘é€æ¶ˆæ¯:', selectedSession.value.user_id, messageText)\r\n      const response = await ChatApi.sendMessage(messageText, selectedSession.value.user_id)\r\n\r\n      if (response.success) {\r\n        // æ·»åŠ æ¶ˆæ¯åˆ°æœ¬åœ°æ˜¾ç¤ºï¼ˆå®¢æœå‘é€çš„æ¶ˆæ¯ï¼‰\r\n        const adminMessage = {\r\n          id: Date.now(),\r\n          user_id: selectedSession.value.user_id, // æ¶ˆæ¯å½’å±äºç›®æ ‡ç”¨æˆ·ï¼ˆæ•°æ®åº“å­˜å‚¨ï¼‰\r\n          senderId: userStore.user?.id, // å‘é€è€…IDï¼ˆç”¨äºUIåˆ¤æ–­ï¼‰\r\n          message: messageText,\r\n          message_type: 'customer_service',\r\n          isAdmin: true,\r\n          avatar: userStore.user?.avatar,\r\n          nickname: userStore.userDisplayName,\r\n          userName: userStore.userDisplayName,\r\n          timestamp: Date.now(),\r\n          created_at: new Date().toISOString(),\r\n          data: {\r\n            userId: userStore.user?.id, // ç¡®ä¿dataä¸­ä¹Ÿæœ‰å‘é€è€…ID\r\n            userName: userStore.userDisplayName,\r\n            isAdmin: true\r\n          }\r\n        }\r\n\r\n        messages.value.push(adminMessage)\r\n        console.log('æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå·²æ·»åŠ åˆ°æœ¬åœ°æ˜¾ç¤º')\r\n      }\r\n    } else {\r\n      // é»˜è®¤å®¢æœæ¨¡å¼ï¼Œé€šè¿‡WebSocketå‘é€\r\n      if (!isConnected.value || !websocket) {\r\n        console.error('WebSocketæœªè¿æ¥')\r\n        return\r\n      }\r\n\r\n      const message = {\r\n        type: 'message',\r\n        data: {\r\n          message: messageText,\r\n          user_id: userStore.user?.id,\r\n          userId: userStore.user?.id\r\n        }\r\n      }\r\n\r\n      websocket.send(JSON.stringify(message))\r\n\r\n      // æ·»åŠ åˆ°æœ¬åœ°æ¶ˆæ¯åˆ—è¡¨\r\n      const userAvatar = userStore.user?.avatar\r\n      messages.value.push({\r\n        ...message,\r\n        data: {\r\n          ...message.data,\r\n          userId: userStore.user?.id,\r\n          userName: userStore.userDisplayName,\r\n          isAdmin: false,\r\n          avatar: userAvatar\r\n        },\r\n        user_id: userStore.user?.id,\r\n        timestamp: Date.now(),\r\n        isAdmin: false,\r\n        message_type: 'user',\r\n        avatar: userAvatar,\r\n        nickname: userStore.user?.nickname || userStore.userDisplayName,\r\n        userName: userStore.userDisplayName\r\n      })\r\n    }\r\n\r\n    newMessage.value = ''\r\n\r\n    // é‡ç½®textareaé«˜åº¦\r\n    nextTick(() => {\r\n      const textarea = document.querySelector('textarea')\r\n      if (textarea) {\r\n        textarea.style.height = '48px'\r\n      }\r\n    })\r\n\r\n    scrollToBottom()\r\n\r\n    // å‘é€æ¶ˆæ¯ååœæ­¢è¾“å…¥çŠ¶æ€\r\n    sendStopTyping()\r\n\r\n  } catch (error) {\r\n    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// å‘é€å¿«é€Ÿæ¶ˆæ¯\r\nconst sendQuickMessage = (message) => {\r\n  newMessage.value = message\r\n  sendMessage()\r\n}\r\n\r\n// è¾“å…¥æ¡†ç„¦ç‚¹çŠ¶æ€ç®¡ç†\r\nconst isInputFocused = ref(false)\r\n\r\n// å¤„ç†è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹\r\nconst handleInputFocus = () => {\r\n  console.log('è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹')\r\n  isInputFocused.value = true\r\n\r\n  // å‘é€æ­£åœ¨è¾“å…¥çŠ¶æ€ï¼ˆèŠ‚æµå‘é€ï¼‰\r\n  if (!isConnected.value || !websocket) return\r\n\r\n  try {\r\n    websocket.send(JSON.stringify({\r\n      type: 'typing',\r\n      data: {\r\n        userId: userStore.user?.id,\r\n        userName: userStore.userDisplayName,\r\n        nickname: userStore.user?.nickname || userStore.userDisplayName,\r\n        avatar: userStore.user?.avatar,\r\n        targetUserId: selectedSession.value?.user_id,\r\n        chatMode: selectedSession.value ? 'user_conversation' : 'customer_service',\r\n        isAdmin: userStore.user?.role === 'admin',\r\n        isCustomerService: userStore.user?.role === 'admin' || userStore.user?.role === 'customer_service'\r\n      }\r\n    }))\r\n  } catch (error) {\r\n    console.error('å‘é€è¾“å…¥çŠ¶æ€å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// å¤„ç†è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹\r\nconst handleInputBlur = () => {\r\n  console.log('è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹')\r\n  isInputFocused.value = false\r\n\r\n  // å»¶è¿Ÿå‘é€åœæ­¢è¾“å…¥çŠ¶æ€ï¼Œé¿å…å¿«é€Ÿç„¦ç‚¹åˆ‡æ¢å¯¼è‡´çš„é—ªçƒ\r\n  setTimeout(() => {\r\n    if (!isInputFocused.value) {\r\n      sendStopTyping()\r\n    }\r\n  }, 500)\r\n}\r\n\r\nconst sendStopTyping = () => {\r\n  if (!isConnected.value || !websocket) return\r\n\r\n  try {\r\n    websocket.send(JSON.stringify({\r\n      type: 'stop_typing',\r\n      data: {\r\n        userId: userStore.user?.id,\r\n        userName: userStore.userDisplayName,\r\n        nickname: userStore.user?.nickname || userStore.userDisplayName,\r\n        avatar: userStore.user?.avatar,\r\n        targetUserId: selectedSession.value?.user_id,\r\n        chatMode: selectedSession.value ? 'user_conversation' : 'customer_service',\r\n        isAdmin: userStore.user?.role === 'admin',\r\n        isCustomerService: userStore.user?.role === 'admin' || userStore.user?.role === 'customer_service'\r\n      }\r\n    }))\r\n  } catch (error) {\r\n    console.error('å‘é€åœæ­¢è¾“å…¥çŠ¶æ€å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// åŠ è½½æ•°æ®\r\nconst loadChatHistory = async () => {\r\n  try {\r\n    const response = await ChatApi.getChatHistory({ limit: 50 })\r\n    if (response.success && response.data) {\r\n      messages.value = response.data.map(msg => {\r\n        console.log('å†å²æ¶ˆæ¯:', msg)\r\n\r\n        // åˆ¤æ–­æ˜¯å¦ä¸ºå®¢æœæ¶ˆæ¯çš„é€»è¾‘\r\n        const isCustomerService = msg.message_type === 'customer_service' ||\r\n          msg.role === 'admin' ||\r\n          msg.role === 'customer_service'\r\n\r\n        const processedMsg = {\r\n          ...msg,\r\n          user_id: msg.user_id || msg.id, // ç¡®ä¿æœ‰user_id\r\n          isAdmin: isCustomerService,\r\n          avatar: msg.avatar || msg.user_avatar, // ä¼˜å…ˆä½¿ç”¨æ¶ˆæ¯å¤´åƒï¼Œå†ä½¿ç”¨ç”¨æˆ·å¤´åƒ\r\n          nickname: msg.nickname || msg.user_nickname || msg.username,\r\n          userName: msg.nickname || msg.user_nickname || msg.username,\r\n          message_type: isCustomerService ? 'customer_service' : 'user'\r\n        }\r\n\r\n        console.log('å¤„ç†åçš„å†å²æ¶ˆæ¯:', processedMsg, {\r\n          isCustomerService,\r\n          userId: msg.user_id,\r\n          currentUserId: userStore.user?.id,\r\n          isCurrentUser: msg.user_id === userStore.user?.id\r\n        })\r\n\r\n        return processedMsg\r\n      })\r\n      console.log('æ‰€æœ‰å¤„ç†åçš„å†å²æ¶ˆæ¯:', messages.value)\r\n      scrollToBottom()\r\n    }\r\n  } catch (error) {\r\n    console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\nconst loadChatSessions = async () => {\r\n  try {\r\n    const response = await ChatApi.getUserSessions({ limit: 20 })\r\n    if (response.success && response.data) {\r\n      sessions.value = response.data.map(session => {\r\n        console.log('åŸå§‹ç”¨æˆ·ä¼šè¯æ•°æ®:', session)\r\n        const processedSession = {\r\n          ...session,\r\n          id: session.user_id, // ä½¿ç”¨user_idä½œä¸ºä¼šè¯ID\r\n          user_avatar: session.avatar,\r\n          user_nickname: session.nickname,\r\n          user_name: session.nickname || session.username,\r\n          unread_count: session.unread_count || 0,\r\n          last_message: session.last_message,\r\n          last_message_time: session.last_message_time,\r\n          last_message_type: session.last_message_type,\r\n          isOnline: session.isOnline || false, // åœ¨çº¿çŠ¶æ€\r\n          displayName: session.displayName || session.nickname || session.username, // æ˜¾ç¤ºåç§°\r\n          status: 'active' // é»˜è®¤çŠ¶æ€\r\n        }\r\n        console.log('å¤„ç†åçš„ç”¨æˆ·ä¼šè¯æ•°æ®:', processedSession)\r\n        return processedSession\r\n      })\r\n    }\r\n  } catch (error) {\r\n    console.error('åŠ è½½ç”¨æˆ·ä¼šè¯åˆ—è¡¨å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\nconst loadServiceStatus = async () => {\r\n  try {\r\n    const response = await ChatApi.getServiceStatus()\r\n    if (response.success) {\r\n      serviceStatus.value = response.data\r\n    }\r\n  } catch (error) {\r\n    console.error('è·å–æœåŠ¡çŠ¶æ€å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\nconst loadUnreadCount = async () => {\r\n  try {\r\n    const response = await ChatApi.getUnreadCount()\r\n    if (response.success) {\r\n      unreadCount.value = response.data.unreadCount\r\n    }\r\n  } catch (error) {\r\n    console.error('è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»\r\nconst markAllMessagesAsRead = async () => {\r\n  try {\r\n    const response = await ChatApi.markMessagesAsRead()\r\n    if (response.success) {\r\n      unreadCount.value = response.data.unreadCount\r\n    }\r\n  } catch (error) {\r\n    console.error('æ ‡è®°æ¶ˆæ¯å·²è¯»å¤±è´¥:', error)\r\n  }\r\n}\r\n\r\n// å·¥å…·å‡½æ•°\r\nconst scrollToBottom = () => {\r\n  nextTick(() => {\r\n    if (messagesContainer.value) {\r\n      messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight\r\n    }\r\n  })\r\n}\r\n\r\n// åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„æ¶ˆæ¯\r\nconst isCurrentUserMessage = (message) => {\r\n  const currentUserId = userStore.user?.id\r\n\r\n  // å¦‚æœæ˜¯å®¢æœæ¶ˆæ¯ç±»å‹ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç®¡ç†å‘˜å‘é€çš„\r\n  if (message.message_type === 'customer_service' || message.isAdmin) {\r\n    // æ£€æŸ¥å‘é€è€…ä¿¡æ¯ï¼Œä¼˜å…ˆä½¿ç”¨ senderId æˆ– data.userId\r\n    const senderId = message.senderId || message.data?.userId || message.data?.senderId\r\n    if (senderId) {\r\n      return senderId === currentUserId\r\n    }\r\n\r\n    // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„å‘é€è€…IDï¼Œæ£€æŸ¥æ˜µç§°/ç”¨æˆ·åæ˜¯å¦åŒ¹é…\r\n    const senderName = message.nickname || message.userName || message.data?.userName\r\n    const currentUserName = userStore.userDisplayName\r\n    if (senderName && currentUserName) {\r\n      return senderName === currentUserName\r\n    }\r\n  }\r\n\r\n  // å¯¹äºæ™®é€šç”¨æˆ·æ¶ˆæ¯ï¼Œä½¿ç”¨ user_id åˆ¤æ–­\r\n  const messageUserId = message.user_id || message.data?.user_id || message.data?.userId\r\n  return messageUserId === currentUserId\r\n}\r\n\r\n// åˆ¤æ–­æ˜¯å¦ä¸ºå®¢æœæ¶ˆæ¯ï¼ˆä»…ç”¨äºæ˜¾ç¤ºå®¢æœæ ‡è¯†ï¼Œä¸å½±å“ä½ç½®ï¼‰\r\nconst isCustomerServiceMessage = (message) => {\r\n  // å¤šé‡æ£€æŸ¥ç¡®ä¿æ­£ç¡®è¯†åˆ«å®¢æœæ¶ˆæ¯\r\n  return message.isAdmin === true ||\r\n    message.message_type === 'customer_service' ||\r\n    message.data?.isAdmin === true ||\r\n    message.data?.isCustomerService === true ||\r\n    message.data?.role === 'admin' ||\r\n    message.data?.role === 'customer_service'\r\n}\r\n\r\nconst formatTime = (timestamp) => {\r\n  if (!timestamp) return ''\r\n\r\n  const date = new Date(timestamp)\r\n  const now = new Date()\r\n  const diffInMs = now - date\r\n  const diffInMinutes = Math.floor(diffInMs / (1000 * 60))\r\n  const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60))\r\n  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24))\r\n\r\n  // å¦‚æœæ˜¯ä»Šå¤©\r\n  if (diffInDays === 0) {\r\n    if (diffInMinutes < 1) {\r\n      return 'åˆšåˆš'\r\n    } else if (diffInMinutes < 60) {\r\n      return `${diffInMinutes}åˆ†é’Ÿå‰`\r\n    } else {\r\n      return date.toLocaleTimeString('zh-CN', {\r\n        hour12: false,\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n      })\r\n    }\r\n  }\r\n  // å¦‚æœæ˜¯æ˜¨å¤©\r\n  else if (diffInDays === 1) {\r\n    return `æ˜¨å¤© ${date.toLocaleTimeString('zh-CN', {\r\n      hour12: false,\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    })}`\r\n  }\r\n  // å¦‚æœæ˜¯æ›´æ—©\r\n  else if (diffInDays < 7) {\r\n    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']\r\n    return `${weekdays[date.getDay()]} ${date.toLocaleTimeString('zh-CN', {\r\n      hour12: false,\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    })}`\r\n  }\r\n  // è¶…è¿‡ä¸€å‘¨\r\n  else {\r\n    return date.toLocaleDateString('zh-CN', {\r\n      month: '2-digit',\r\n      day: '2-digit',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    })\r\n  }\r\n}\r\n\r\nconst formatDate = (dateString) => {\r\n  if (!dateString) return ''\r\n\r\n  const date = new Date(dateString)\r\n  const now = new Date()\r\n  const diffInMs = now - date\r\n  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24))\r\n\r\n  if (diffInDays === 0) {\r\n    return date.toLocaleTimeString('zh-CN', {\r\n      hour12: false,\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    })\r\n  } else if (diffInDays === 1) {\r\n    return 'æ˜¨å¤©'\r\n  } else if (diffInDays < 7) {\r\n    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']\r\n    return weekdays[date.getDay()]\r\n  } else {\r\n    return date.toLocaleDateString('zh-CN', {\r\n      month: '2-digit',\r\n      day: '2-digit'\r\n    })\r\n  }\r\n}\r\n\r\nconst getSessionStatusClass = (status) => {\r\n  switch (status) {\r\n    case 'active':\r\n      return 'bg-green-500/20 text-green-400 border-green-500/30'\r\n    case 'waiting':\r\n      return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'\r\n    case 'closed':\r\n      return 'bg-gray-500/20 text-gray-400 border-gray-500/30'\r\n    default:\r\n      return 'bg-gray-500/20 text-gray-400 border-gray-500/30'\r\n  }\r\n}\r\n\r\nconst getSessionStatusText = (status) => {\r\n  switch (status) {\r\n    case 'active':\r\n      return 'è¿›è¡Œä¸­'\r\n    case 'waiting':\r\n      return 'ç­‰å¾…ä¸­'\r\n    case 'closed':\r\n      return 'å·²ç»“æŸ'\r\n    default:\r\n      return 'æœªçŸ¥'\r\n  }\r\n}\r\n\r\nconst getMessageAvatar = (message) => {\r\n  // è·å–å‘é€è€…å¤´åƒï¼Œä¼˜å…ˆçº§ï¼šmessage.avatar > message.data.avatar\r\n  const avatar = message.avatar || message.data?.avatar\r\n  // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²å’Œæ— æ•ˆURL\r\n  if (avatar && avatar.trim() && avatar !== 'null' && avatar !== 'undefined') {\r\n    return avatar.trim()\r\n  }\r\n  return null\r\n}\r\n\r\nconst getMessageNickname = (message) => {\r\n  return message.nickname || message.data?.nickname || message.userName || message.data?.userName || 'ç”¨æˆ·'\r\n}\r\n\r\nconst getUserAvatar = (message) => {\r\n  // è·å–å½“å‰ç”¨æˆ·å¤´åƒ\r\n  const avatar = message.avatar || message.data?.avatar || userStore.user?.avatar\r\n  // è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²å’Œæ— æ•ˆURL\r\n  if (avatar && avatar.trim() && avatar !== 'null' && avatar !== 'undefined') {\r\n    return avatar.trim()\r\n  }\r\n  return null\r\n}\r\n\r\nconst getUserNickname = (message) => {\r\n  return message.nickname || message.data?.nickname || message.userName || message.data?.userName || userStore.userDisplayName\r\n}\r\n\r\n// å¤´åƒé”™è¯¯å¤„ç†\r\nconst handleAvatarError = (event) => {\r\n  console.log('å¤´åƒåŠ è½½å¤±è´¥:', event.target.src)\r\n  event.target.style.display = 'none'\r\n}\r\n\r\n// å¤´åƒåŠ è½½æˆåŠŸå¤„ç†\r\nconst handleAvatarLoad = (event) => {\r\n  console.log('å¤´åƒåŠ è½½æˆåŠŸ:', event.target.src)\r\n}\r\n\r\n// è‡ªåŠ¨æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»\r\nconst autoMarkAsRead = async () => {\r\n  if (unreadCount.value > 0) {\r\n    try {\r\n      const response = await ChatApi.markMessagesAsRead()\r\n      if (response.success) {\r\n        unreadCount.value = 0\r\n        console.log('æ¶ˆæ¯å·²è‡ªåŠ¨æ ‡è®°ä¸ºå·²è¯»')\r\n      }\r\n    } catch (error) {\r\n      console.error('è‡ªåŠ¨æ ‡è®°æ¶ˆæ¯å·²è¯»å¤±è´¥:', error)\r\n    }\r\n  }\r\n}\r\n\r\n// é€‰æ‹©ä¼šè¯\r\nconst selectSession = async (session) => {\r\n  console.log('é€‰ä¸­ç”¨æˆ·ä¼šè¯:', session)\r\n  \r\n  // æ¸…é™¤ä¹‹å‰çš„typingçŠ¶æ€\r\n  clearTypingStates()\r\n  \r\n  selectedSession.value = session\r\n\r\n  // åŠ è½½è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•\r\n  await loadChatHistoryForSession(session.user_id)\r\n\r\n  // æ ‡è®°è¯¥ç”¨æˆ·çš„æ¶ˆæ¯ä¸ºå·²è¯»\r\n  if (session.unread_count > 0) {\r\n    await markSessionAsRead(session.user_id)\r\n    // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„æœªè¯»æ•°é‡\r\n    session.unread_count = 0\r\n  }\r\n}\r\n\r\n// åŠ è½½ç‰¹å®šä¼šè¯çš„èŠå¤©è®°å½•\r\nconst loadChatHistoryForSession = async (sessionId) => {\r\n  try {\r\n    console.log('åŠ è½½ç”¨æˆ·èŠå¤©è®°å½•:', sessionId)\r\n    // ä½¿ç”¨æ–°çš„ getUserMessages æ¥å£\r\n    const response = await ChatApi.getUserMessages(sessionId, {\r\n      limit: 50\r\n    })\r\n\r\n    if (response.success && response.data) {\r\n      messages.value = response.data.map(msg => {\r\n        console.log('ç”¨æˆ·æ¶ˆæ¯:', msg)\r\n\r\n        // åˆ¤æ–­æ˜¯å¦ä¸ºå®¢æœæ¶ˆæ¯çš„é€»è¾‘\r\n        const isCustomerService = msg.message_type === 'customer_service' ||\r\n          msg.role === 'admin' ||\r\n          msg.role === 'customer_service' ||\r\n          msg.is_admin_message === 1\r\n\r\n        const processedMsg = {\r\n          ...msg,\r\n          user_id: msg.user_id || msg.id,\r\n          isAdmin: isCustomerService,\r\n          avatar: msg.avatar,\r\n          nickname: msg.nickname || msg.username,\r\n          userName: msg.nickname || msg.username,\r\n          message_type: isCustomerService ? 'customer_service' : 'user'\r\n        }\r\n\r\n        return processedMsg\r\n      })\r\n\r\n      console.log('ç”¨æˆ·èŠå¤©è®°å½•åŠ è½½å®Œæˆ:', messages.value)\r\n      scrollToBottom()\r\n    }\r\n  } catch (error) {\r\n    console.error('åŠ è½½ç”¨æˆ·èŠå¤©è®°å½•å¤±è´¥:', error)\r\n    // å¦‚æœAPIä¸æ”¯æŒæŒ‰ç”¨æˆ·åŠ è½½ï¼Œå›é€€åˆ°åŠ è½½å…¨éƒ¨è®°å½•\r\n    await loadChatHistory()\r\n  }\r\n}\r\n\r\n// æ ‡è®°ç‰¹å®šä¼šè¯ä¸ºå·²è¯»\r\nconst markSessionAsRead = async (sessionId) => {\r\n  try {\r\n    const response = await ChatApi.markSessionAsRead(sessionId)\r\n    if (response.success) {\r\n      console.log('ä¼šè¯å·²æ ‡è®°ä¸ºå·²è¯»:', sessionId)\r\n      // æ›´æ–°æ€»çš„æœªè¯»æ•°é‡\r\n      await loadUnreadCount()\r\n    }\r\n  } catch (error) {\r\n    console.error('æ ‡è®°ä¼šè¯å·²è¯»å¤±è´¥:', error)\r\n    // å¦‚æœAPIä¸æ”¯æŒï¼Œä½¿ç”¨é€šç”¨çš„æ ‡è®°å·²è¯»\r\n    await autoMarkAsRead()\r\n  }\r\n}\r\n\r\n// è¿”å›å®¢æœæ¨¡å¼\r\nconst backToCustomerService = () => {\r\n  console.log('è¿”å›å®¢æœæ¨¡å¼')\r\n  \r\n  // æ¸…é™¤typingçŠ¶æ€\r\n  clearTypingStates()\r\n  \r\n  selectedSession.value = null\r\n  // é‡æ–°åŠ è½½é»˜è®¤çš„èŠå¤©è®°å½•\r\n  loadChatHistory()\r\n}\r\n\r\n// æ›´æ–°ä¼šè¯åˆ—è¡¨\r\nconst updateSessionList = (message) => {\r\n  const messageUserId = message.user_id\r\n  const sessionIndex = sessions.value.findIndex(s => s.user_id === messageUserId)\r\n\r\n  if (sessionIndex >= 0) {\r\n    // æ›´æ–°ç°æœ‰ä¼šè¯\r\n    const session = sessions.value[sessionIndex]\r\n    session.last_message = message.message || message.data?.message\r\n    session.last_message_time = new Date().toISOString()\r\n\r\n    // å¦‚æœä¸æ˜¯å½“å‰é€‰ä¸­çš„ä¼šè¯ä¸”æ¶ˆæ¯ç±»å‹æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œå¢åŠ æœªè¯»æ•°é‡\r\n    if ((!selectedSession.value || selectedSession.value.user_id !== messageUserId) &&\r\n      message.message_type === 'user') {\r\n      session.unread_count = (session.unread_count || 0) + 1\r\n    }\r\n\r\n    // å°†ä¼šè¯ç§»åˆ°åˆ—è¡¨é¡¶éƒ¨\r\n    sessions.value.splice(sessionIndex, 1)\r\n    sessions.value.unshift(session)\r\n  } else if (message.message_type === 'user') {\r\n    // æ–°ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼Œé‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨\r\n    loadChatSessions()\r\n  }\r\n}\r\n\r\n// æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œåˆå§‹åŒ–\r\nonMounted(async () => {\r\n  if (!userStore.isLoggedIn) {\r\n    // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢\r\n    navigateTo('/auth/login')\r\n    return\r\n  }\r\n\r\n  // åŠ è½½é¡µé¢æ•°æ®\r\n  await Promise.all([\r\n    loadServiceStatus(),\r\n    loadUnreadCount(),\r\n    loadChatHistory(),\r\n    loadChatSessions()\r\n  ])\r\n  connectWebSocket()\r\n})\r\n\r\nonUnmounted(() => {\r\n  disconnectWebSocket()\r\n})\r\n</script>\r\n\r\n<style scoped>\r\n.glass-card-dark {\r\n  background: rgba(31, 41, 55, 0.8);\r\n  backdrop-filter: blur(20px);\r\n  -webkit-backdrop-filter: blur(20px);\r\n}\r\n\r\n/* æ»šåŠ¨æ¡æ ·å¼ */\r\n.overflow-y-auto::-webkit-scrollbar {\r\n  width: 6px;\r\n}\r\n\r\n.overflow-y-auto::-webkit-scrollbar-track {\r\n  background: rgba(55, 65, 81, 0.3);\r\n  border-radius: 3px;\r\n}\r\n\r\n.overflow-y-auto::-webkit-scrollbar-thumb {\r\n  background: rgba(156, 163, 175, 0.5);\r\n  border-radius: 3px;\r\n}\r\n\r\n.overflow-y-auto::-webkit-scrollbar-thumb:hover {\r\n  background: rgba(156, 163, 175, 0.7);\r\n}\r\n\r\n/* éšè—è¾“å…¥æ¡†æ»šåŠ¨æ¡ */\r\n.hide-scrollbar {\r\n  /* éšè— Webkit æµè§ˆå™¨æ»šåŠ¨æ¡ */\r\n  -webkit-overflow-scrolling: touch;\r\n  scrollbar-width: none; /* Firefox */\r\n  -ms-overflow-style: none; /* IE å’Œ Edge */\r\n}\r\n\r\n.hide-scrollbar::-webkit-scrollbar {\r\n  display: none; /* Chrome, Safari, Opera */\r\n}\r\n\r\n/* è‡ªå®šä¹‰åŠ¨ç”» */\r\n@keyframes fadeInUp {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(30px);\r\n  }\r\n\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes fadeInLeft {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateX(-30px);\r\n  }\r\n\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateX(0);\r\n  }\r\n}\r\n\r\n@keyframes fadeInRight {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateX(30px);\r\n  }\r\n\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateX(0);\r\n  }\r\n}\r\n\r\n@keyframes bounceGentle {\r\n\r\n  0%,\r\n  20%,\r\n  50%,\r\n  80%,\r\n  100% {\r\n    transform: translateY(0);\r\n  }\r\n\r\n  40% {\r\n    transform: translateY(-3px);\r\n  }\r\n\r\n  60% {\r\n    transform: translateY(-2px);\r\n  }\r\n}\r\n\r\n@keyframes pulseGentle {\r\n\r\n  0%,\r\n  100% {\r\n    transform: scale(1);\r\n    opacity: 1;\r\n  }\r\n\r\n  50% {\r\n    transform: scale(1.05);\r\n    opacity: 0.8;\r\n  }\r\n}\r\n\r\n@keyframes bounce {\r\n\r\n  0%,\r\n  20%,\r\n  53%,\r\n  80%,\r\n  100% {\r\n    transform: translate3d(0, 0, 0);\r\n  }\r\n\r\n  40%,\r\n  43% {\r\n    transform: translate3d(0, -8px, 0);\r\n  }\r\n\r\n  70% {\r\n    transform: translate3d(0, -4px, 0);\r\n  }\r\n\r\n  90% {\r\n    transform: translate3d(0, -2px, 0);\r\n  }\r\n}\r\n\r\n/* åŠ¨ç”»ç±» */\r\n.animate-fade-in-up {\r\n  animation: fadeInUp 0.8s ease-out forwards;\r\n}\r\n\r\n.animate-fade-in-left {\r\n  animation: fadeInLeft 0.8s ease-out forwards;\r\n  animation-delay: 0.2s;\r\n  opacity: 0;\r\n}\r\n\r\n.animate-fade-in-right {\r\n  animation: fadeInRight 0.8s ease-out forwards;\r\n  animation-delay: 0.3s;\r\n  opacity: 0;\r\n}\r\n\r\n.animate-bounce-gentle {\r\n  animation: bounceGentle 2s ease-in-out infinite;\r\n}\r\n\r\n.animate-pulse-gentle {\r\n  animation: pulseGentle 2s ease-in-out infinite;\r\n}\r\n\r\n.animate-bounce {\r\n  animation: bounce 1s infinite;\r\n}\r\n\r\n/* æ¶ˆæ¯åŠ¨ç”» */\r\n.message-enter-active {\r\n  transition: all 0.5s ease-out;\r\n}\r\n\r\n.message-enter-from {\r\n  opacity: 0;\r\n  transform: translateY(20px) scale(0.9);\r\n}\r\n\r\n.message-enter-to {\r\n  opacity: 1;\r\n  transform: translateY(0) scale(1);\r\n}\r\n\r\n/* ä¼šè¯é€‰ä¸­çŠ¶æ€ä¼˜åŒ– */\r\n.session-selected {\r\n  background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);\r\n  border: 1px solid rgba(6, 182, 212, 0.4);\r\n  box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);\r\n}\r\n\r\n.session-selected::before {\r\n  content: '';\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  border-radius: 12px;\r\n  background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);\r\n  pointer-events: none;\r\n  z-index: -1;\r\n}\r\n\r\n/* å“åº”å¼è®¾è®¡ä¼˜åŒ– */\r\n@media (max-width: 1280px) {\r\n\r\n  .xl\\\\:col-span-1,\r\n  .xl\\\\:col-span-3 {\r\n    grid-column: span 1;\r\n  }\r\n\r\n  .grid.xl\\\\:grid-cols-4 {\r\n    grid-template-columns: repeat(1, minmax(0, 1fr));\r\n    gap: 1rem;\r\n  }\r\n}\r\n\r\n@media (max-width: 768px) {\r\n\r\n  .animate-fade-in-left,\r\n  .animate-fade-in-right {\r\n    animation-delay: 0.1s;\r\n  }\r\n\r\n  .h-\\\\[750px\\\\] {\r\n    height: 500px;\r\n  }\r\n\r\n  .px-6 {\r\n    padding-left: 1rem;\r\n    padding-right: 1rem;\r\n  }\r\n\r\n  .py-8 {\r\n    padding-top: 1.5rem;\r\n    padding-bottom: 1.5rem;\r\n  }\r\n\r\n  .text-4xl {\r\n    font-size: 2rem;\r\n  }\r\n\r\n  .text-2xl {\r\n    font-size: 1.5rem;\r\n  }\r\n}\r\n</style>"],"names":["_ssrRenderAttrs","_mergeProps","_ssrRenderClass","_ssrInterpolate","_ssrRenderList"],"mappings":"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"}