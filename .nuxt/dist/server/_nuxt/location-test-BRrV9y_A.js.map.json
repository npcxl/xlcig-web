{"file":"location-test-BRrV9y_A.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAkQA,UAAM,YAAY,aAAA;AAClB,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MAGA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,IACE,YAAA;;;;AA3QG,YAAA,OAAAA,eAAAC,WAAA,EAAA,OAAM,6EAAyE,MAAA,CAAA,CAAA,gyBAAA;UAiB5DC,MAAA,cAAA,GAAc;;;;;;UAQmBA,MAAA,cAAA,GAAc;0MAGxDC,eAAAD,MAAA,SAAA,EAAU,eAAe,0BAAYA,WAAA,SAAA,EAAU,SAAVA,mBAAgB,EAAE;;;;iDAMvBA,MAAA,cAAA,IAAc,+CAAA,gDAAA,qBAAA,CAAA,oGAECA,MAAA,cAAA,IAAc,mBAAA,mBAAA,kCAAA,CAAA,2EAE1BA,MAAA,cAAA,IAAc,mBAAA,mBAAA,kBAAA,CAAA,qCAC/CA,MAAA,cAAA,IAAc,WAAA,QAAA,sCAEUA,MAAA,cAAA,IAAc,mBAAA,mBAAA,SAAA,CAAA;UAC9BA,MAAA,cAAA,GAAc;;;;;;WAafA,MAAA,cAAA,GAAc;;;UACd,IAAG;AAAA,UAAc,OAAM;AAAA,QAAA;2BAAjC,CAEW,GAAAE,QAAAC,UAAA,aAAA;;;;;gCAFgH,QAE3H;AAAA,cAAA;AAAA;;;;;;;;;UAeGH,MAAA,OAAA,GAAO;;iBAMFA,MAAA,KAAA,GAAK;2PAIqBA,MAAA,KAAA,CAAK,CAAA,mMAAA;AAAA,iBAS/BA,MAAA,IAAA,GAAI;ySAKkCC,eAAAD,MAAA,IAAA,EAAK,EAAE,0MAIpBA,MAAA,eAAA,EAAA,CAAe;AAK3C,YAAAA,MAAA,IAAA,EAAK,YAAQ,CAAKA,YAAK,SAAS,OAAK;;cACGA,MAAA,IAAA,EAAK,SAAS,UAAQ;+MAElCA,MAAA,IAAA,EAAK,SAAS,QAAQ,CAAA,cAAA;AAAA;;;cAEVA,MAAA,IAAA,EAAK,SAAS,MAAI;+MAE9BA,MAAA,IAAA,EAAK,SAAS,IAAI,CAAA,cAAA;AAAA;;;cAENA,MAAA,IAAA,EAAK,SAAS,QAAM;2NAEtBA,MAAA,IAAA,EAAK,SAAS,MAAM,CAAA,cAAA;AAAA;;;;;;;;AASnD,YAAAA,MAAA,IAAA,EAAK,QAAM;;;;;;AAQsB,YAAAA,MAAA,SAAA,EAAU,YAAU;;cAGrDA,MAAA,qBAAA,GAAqB;;;;;;;;;iGAalBA,MAAA,OAAA,CAAO,IAAA,cAAA,8KAEwCA,MAAA,OAAA,EAAA,GAAO,4BAAA,CAAA,sEAItDA,MAAA,OAAA,CAAO,IAAA,cAAA;aAKXA,MAAA,cAAA,GAAc;;;;;;;UAmBI,IAAG;AAAA,UAAc,OAAM;AAAA,QAAA;2BAAjC,CAA6E,GAAAE,QAAAC,UAAA,aAAA;;;;;gCAAb,IAAE;AAAA,cAAA;AAAA;;;;;;;;;;;;;;;;;;;","names":["_ssrRenderAttrs","_mergeProps","_unref","_ssrInterpolate","_push","_parent"],"sources":["../../../../pages/location-test.vue"],"sourcesContent":["<template>\r\n  <div class=\"min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-black p-6\">\r\n    <div class=\"max-w-4xl mx-auto\">\r\n      <div class=\"text-center mb-8\">\r\n        <h1 class=\"text-4xl font-bold text-white mb-4\">🌍 IP位置定位测试</h1>\r\n        <p class=\"text-gray-300 text-lg\">测试首页IP获取、用户登录检测、高德API调用等完整流程</p>\r\n      </div>\r\n\r\n      <!-- 用户登录状态 -->\r\n      <div class=\"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 mb-6\">\r\n        <h2 class=\"text-2xl font-semibold text-white mb-4 flex items-center\">\r\n          <i class=\"bi bi-person-check mr-3 text-cyan-400\"></i>\r\n          用户登录状态检查\r\n        </h2>\r\n        <div class=\"grid md:grid-cols-2 gap-4\">\r\n          <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n            <div class=\"text-sm text-gray-400 mb-1\">前端登录检查</div>\r\n            <div class=\"text-lg font-medium\">\r\n              <span v-if=\"isUserLoggedIn\" class=\"text-green-400\">\r\n                <i class=\"bi bi-check-circle mr-2\"></i>已登录 (前端验证)\r\n              </span>\r\n              <span v-else class=\"text-red-400\">\r\n                <i class=\"bi bi-x-circle mr-2\"></i>未登录 (前端验证)\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <div class=\"p-4 bg-gray-800/30 rounded-lg\" v-if=\"isUserLoggedIn\">\r\n            <div class=\"text-sm text-gray-400 mb-1\">用户信息</div>\r\n            <div class=\"text-lg font-medium text-white\">\r\n              {{ userStore.userDisplayName }} (ID: {{ userStore.user?.id }})\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- 登录状态说明 -->\r\n        <div class=\"mt-4 p-4 rounded-lg\" :class=\"isUserLoggedIn ? 'bg-green-500/10 border border-green-500/30' : 'bg-yellow-500/10 border border-yellow-500/30'\">\r\n          <div class=\"flex items-start gap-3\">\r\n            <i class=\"bi bi-info-circle text-lg mt-0.5\" :class=\"isUserLoggedIn ? 'text-green-400' : 'text-yellow-400'\"></i>\r\n            <div>\r\n              <div class=\"font-medium mb-2\" :class=\"isUserLoggedIn ? 'text-green-300' : 'text-yellow-300'\">\r\n                {{ isUserLoggedIn ? '完整功能模式' : '基础功能模式' }}\r\n              </div>\r\n              <div class=\"text-sm\" :class=\"isUserLoggedIn ? 'text-green-200' : 'text-yellow-200'\">\r\n                <div v-if=\"isUserLoggedIn\">\r\n                  ✅ 前端已确认登录状态<br>\r\n                  ✅ API调用时会携带认证token<br>\r\n                  ✅ 后端会更新users表的loginIp和loginIpContent字段<br>\r\n                  ✅ 可以查看个人登录历史记录\r\n                </div>\r\n                <div v-else>\r\n                  ℹ️ 仍可获取IP地址和位置信息<br>\r\n                  ℹ️ 数据会保存到ip_addresses表作为缓存<br>\r\n                  ⚠️ 不会更新个人用户档案<br>\r\n                  💡 请登录以启用完整功能\r\n                </div>\r\n              </div>\r\n              <div v-if=\"!isUserLoggedIn\" class=\"mt-3\">\r\n                <NuxtLink to=\"/auth/login\" class=\"px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm transition-colors\">\r\n                  立即登录\r\n                </NuxtLink>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- IP位置信息卡片 -->\r\n      <div class=\"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 mb-6\">\r\n        <h2 class=\"text-2xl font-semibold text-white mb-4 flex items-center\">\r\n          <i class=\"bi bi-geo-alt mr-3 text-cyan-400\"></i>\r\n          IP位置信息\r\n        </h2>\r\n        \r\n        <!-- 加载状态 -->\r\n        <div v-if=\"loading\" class=\"text-center py-8\">\r\n          <div class=\"w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\r\n          <p class=\"text-white text-lg\">正在获取IP位置信息...</p>\r\n        </div>\r\n\r\n        <!-- 错误状态 -->\r\n        <div v-else-if=\"error\" class=\"text-center py-8\">\r\n          <div class=\"text-red-400 text-6xl mb-4\">\r\n            <i class=\"bi bi-exclamation-triangle\"></i>\r\n          </div>\r\n          <p class=\"text-red-400 text-lg mb-4\">{{ error }}</p>\r\n          <button @click=\"refreshLocation(true)\" \r\n                  class=\"px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors\">\r\n            <i class=\"bi bi-arrow-clockwise mr-2\"></i>\r\n            重新获取\r\n          </button>\r\n        </div>\r\n\r\n        <!-- 成功状态 -->\r\n        <div v-else-if=\"data\" class=\"space-y-4\">\r\n          <!-- 基本IP信息 -->\r\n          <div class=\"grid md:grid-cols-2 gap-4\">\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">IP地址</div>\r\n              <div class=\"text-lg font-mono text-cyan-400\">{{ data.ip }}</div>\r\n            </div>\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">位置</div>\r\n              <div class=\"text-lg text-white\">{{ getLocationText() }}</div>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- 详细位置信息 -->\r\n          <div v-if=\"data.location && !data.location.error\" class=\"grid md:grid-cols-3 gap-4\">\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\" v-if=\"data.location.province\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">省份</div>\r\n              <div class=\"text-lg text-white\">{{ data.location.province }}</div>\r\n            </div>\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\" v-if=\"data.location.city\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">城市</div>\r\n              <div class=\"text-lg text-white\">{{ data.location.city }}</div>\r\n            </div>\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\" v-if=\"data.location.adcode\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">区域编码</div>\r\n              <div class=\"text-lg font-mono text-white\">{{ data.location.adcode }}</div>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- 缓存和用户更新状态 -->\r\n          <div class=\"grid md:grid-cols-2 gap-4\">\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">数据来源</div>\r\n              <div class=\"text-lg\">\r\n                <span v-if=\"data.cached\" class=\"text-green-400\">\r\n                  <i class=\"bi bi-database mr-2\"></i>数据库缓存\r\n                </span>\r\n                <span v-else class=\"text-cyan-400\">\r\n                  <i class=\"bi bi-cloud mr-2\"></i>高德地图API\r\n                </span>\r\n              </div>\r\n            </div>\r\n            <div class=\"p-4 bg-gray-800/30 rounded-lg\" v-if=\"userStore.isLoggedIn\">\r\n              <div class=\"text-sm text-gray-400 mb-1\">登录信息更新</div>\r\n              <div class=\"text-lg\">\r\n                <span v-if=\"isUserLocationUpdated\" class=\"text-green-400\">\r\n                  <i class=\"bi bi-check-circle mr-2\"></i>已更新到数据库\r\n                </span>\r\n                <span v-else class=\"text-yellow-400\">\r\n                  <i class=\"bi bi-clock mr-2\"></i>未更新\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <!-- 操作按钮 -->\r\n          <div class=\"flex gap-4 pt-4\">\r\n            <button @click=\"refreshLocation(true)\"\r\n                    :disabled=\"loading\"\r\n                    class=\"px-6 py-3 bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50 text-white rounded-lg transition-colors\">\r\n              <i class=\"bi bi-arrow-clockwise mr-2\" :class=\"{ 'animate-spin': loading }\"></i>\r\n              强制刷新\r\n            </button>\r\n            <button @click=\"fetchLocation(true)\"\r\n                    :disabled=\"loading\"\r\n                    class=\"px-6 py-3 bg-gray-600 hover:bg-gray-700 disabled:opacity-50 text-white rounded-lg transition-colors\">\r\n              <i class=\"bi bi-geo-alt mr-2\"></i>\r\n              重新定位\r\n            </button>\r\n            <button v-if=\"!isUserLoggedIn\" \r\n                    @click=\"testLogin\"\r\n                    class=\"px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors\">\r\n              <i class=\"bi bi-person-plus mr-2\"></i>\r\n              测试登录\r\n            </button>\r\n            <button v-else \r\n                    @click=\"testLogout\"\r\n                    class=\"px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors\">\r\n              <i class=\"bi bi-box-arrow-right mr-2\"></i>\r\n              测试登出\r\n            </button>\r\n          </div>\r\n          \r\n          <!-- 测试说明 -->\r\n          <div class=\"mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg\">\r\n            <div class=\"text-blue-300 text-sm\">\r\n              <i class=\"bi bi-info-circle mr-2\"></i>\r\n              <strong>测试说明：</strong>\"测试登录\"仅用于演示前端登录状态检查，使用模拟token。\r\n              要测试完整的数据库更新功能，请使用真实账号<NuxtLink to=\"/auth/login\" class=\"text-blue-400 underline ml-1\">登录</NuxtLink>。\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- 技术说明 -->\r\n      <div class=\"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20\">\r\n        <h2 class=\"text-2xl font-semibold text-white mb-4 flex items-center\">\r\n          <i class=\"bi bi-info-circle mr-3 text-cyan-400\"></i>\r\n          功能说明\r\n        </h2>\r\n        <div class=\"space-y-4 text-gray-300\">\r\n          <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n            <h3 class=\"text-lg font-semibold text-white mb-2\">✅ 已实现的功能</h3>\r\n            <ul class=\"space-y-2 text-sm\">\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>前端登录状态检查</strong>：检查localStorage中的认证信息</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>真实IP获取</strong>：使用ipinfo.io获取公网IP，避免代理问题</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>高德地图API调用</strong>：获取IP对应的省市地址信息</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>后端JWT验证</strong>：确保只有真实登录用户才能更新数据库</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>用户表更新</strong>：自动更新loginIp和loginIpContent字段</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>前端实时显示</strong>：显示位置信息和数据库更新状态</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>智能缓存机制</strong>：24小时内重复IP使用数据库缓存</li>\r\n              <li><i class=\"bi bi-check text-green-400 mr-2\"></i><strong>双重安全保障</strong>：前端UX检查 + 后端安全验证</li>\r\n            </ul>\r\n          </div>\r\n          \r\n          <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n            <h3 class=\"text-lg font-semibold text-white mb-2\">🔄 工作流程</h3>\r\n            <ol class=\"space-y-2 text-sm list-decimal list-inside\">\r\n              <li><strong>前端登录检查</strong>：首页加载时检查用户登录状态(localStorage)</li>\r\n              <li><strong>获取真实IP</strong>：HeaderLocation组件调用ipinfo.io获取公网IP</li>\r\n              <li><strong>API调用</strong>：前端调用/api/amap/ip/接口（携带认证token）</li>\r\n              <li><strong>后端验证</strong>：后端验证JWT token确认用户身份</li>\r\n              <li><strong>位置查询</strong>：检查数据库缓存或调用高德地图API获取省市信息</li>\r\n              <li><strong>数据库更新</strong>：如果用户已登录且验证通过，更新用户表</li>\r\n              <li><strong>前端显示</strong>：显示位置信息和更新状态</li>\r\n            </ol>\r\n          </div>\r\n          \r\n          <div class=\"p-4 bg-gray-800/30 rounded-lg\">\r\n            <h3 class=\"text-lg font-semibold text-white mb-2\">🎯 登录状态判断逻辑</h3>\r\n            <div class=\"space-y-3 text-sm\">\r\n              <div class=\"p-3 bg-cyan-500/10 rounded-lg border border-cyan-500/20\">\r\n                <div class=\"font-medium text-cyan-300 mb-1\">📱 前端判断（用户体验）</div>\r\n                <div class=\"text-cyan-200\">\r\n                  • 检查localStorage中的authToken和userInfo<br>\r\n                  • 提供即时的登录状态反馈<br>\r\n                  • 决定是否显示\"登录信息已更新\"等提示\r\n                </div>\r\n              </div>\r\n              <div class=\"p-3 bg-purple-500/10 rounded-lg border border-purple-500/20\">\r\n                <div class=\"font-medium text-purple-300 mb-1\">🔒 后端验证（安全保证）</div>\r\n                <div class=\"text-purple-200\">\r\n                  • 验证JWT token的有效性和完整性<br>\r\n                  • 确保只有真正登录的用户才能更新数据库<br>\r\n                  • 防止恶意请求和数据篡改\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { useLocation } from '../composables/useLocation'\r\nimport { useUserStore } from '../stores/user'\r\n\r\n// 设置页面信息\r\ndefinePageMeta({\r\n  title: 'IP位置定位测试'\r\n})\r\n\r\n// 使用stores和composables\r\nconst userStore = useUserStore()\r\nconst {\r\n  loading,\r\n  data,\r\n  error,\r\n  fetchLocation,\r\n  refreshLocation,\r\n  getLocationText,\r\n  isUserLocationUpdated,\r\n  isUserLoggedIn\r\n} = useLocation()\r\n\r\n// 页面加载时初始化\r\nonMounted(() => {\r\n  // 初始化用户状态\r\n  userStore.initializeAuth()\r\n  \r\n  // 自动获取位置信息\r\n  fetchLocation(false)\r\n})\r\n\r\n// 测试登录功能\r\nconst testLogin = () => {\r\n  // 模拟一个测试用户登录\r\n  const testUser = {\r\n    id: 999,\r\n    username: 'test_user',\r\n    nickname: '测试用户',\r\n    email: 'test@example.com',\r\n    role: 'user',\r\n    created_at: new Date().toISOString(),\r\n    updated_at: new Date().toISOString()\r\n  }\r\n  \r\n  const testToken = 'test_token_for_demo'\r\n  \r\n  // 设置用户登录状态\r\n  userStore.setAuth(testToken, testUser)\r\n  \r\n  // 重新获取位置信息以测试完整流程\r\n  setTimeout(() => {\r\n    fetchLocation(true, true)\r\n  }, 500)\r\n}\r\n\r\n// 测试登出功能\r\nconst testLogout = () => {\r\n  userStore.logout()\r\n  \r\n  // 重新获取位置信息\r\n  setTimeout(() => {\r\n    fetchLocation(true, true)\r\n  }, 500)\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.glass-card-dark {\r\n  background: rgba(31, 41, 55, 0.8);\r\n  backdrop-filter: blur(20px);\r\n}\r\n</style> "],"version":3}