import{_ as Le}from"./B7P3ZcZ_.js";import{_ as De,G as He,r as C,e as he,f as Re,D as Pe,g as Be,c,a as s,b as fe,d as N,p as h,t as v,s as _,F as L,j as D,i as Q,w as Fe,R as Je,q as Ve,C as Ke,m as Ge,x as qe,n as X,o as d,k as xe}from"./DYUlAN8C.js";import{a as b}from"./CFjwhGiX.js";import{u as Qe}from"./wKsX27ps.js";import{s as Xe}from"./x_rD_Ya3.js";import"./B2PraNO7.js";import"./GFptVlNT.js";import"./CD5Qg5Z1.js";class O{static async getChatHistory(n={}){try{return await b.getWithParams("/chat/history",n)}catch(i){throw console.error("获取聊天历史失败:",i),i}}static async getChatSessions(n={}){try{return await b.getWithParams("/chat/sessions",n)}catch(i){throw console.error("获取聊天会话失败:",i),i}}static async closeChatSession(n,i){try{return await b.post(`/chat/sessions/${n}/close`,i)}catch(g){throw console.error("结束聊天会话失败:",g),g}}static async getServiceStatus(){try{return await b.get("/chat/service/status")}catch(n){throw console.error("获取客服状态失败:",n),n}}static async getUnreadCount(){try{return await b.get("/chat/unread-count")}catch(n){throw console.error("获取未读消息数量失败:",n),n}}static async markMessagesAsRead(n){try{return await b.post("/chat/mark-read",{messageIds:n})}catch(i){throw console.error("标记消息已读失败:",i),i}}static async sendSystemMessage(n,i){try{return await b.post("/chat/system/message",{message:n,target_user_id:i})}catch(g){throw console.error("发送系统消息失败:",g),g}}static async getChatStats(){try{return await b.get("/chat/admin/stats")}catch(n){throw console.error("获取聊天统计失败:",n),n}}static async getUserSessions(n={}){try{return await b.getWithParams("/chat/user-sessions",n)}catch(i){throw console.error("获取用户会话列表失败:",i),i}}static async getUserMessages(n,i={}){try{return await b.getWithParams(`/chat/user-messages/${n}`,i)}catch(g){throw console.error("获取用户聊天记录失败:",g),g}}static async sendMessage(n,i){try{return await b.post("/chat/send-message",{message:n,target_user_id:i})}catch(g){throw console.error("发送消息失败:",g),g}}static async markSessionAsRead(n){try{return await b.post("/chat/mark-read",{})}catch(i){throw console.error("标记会话已读失败:",i),i}}static async getUserOnlineStatus(n){try{const i=n?{userIds:n}:{};return await b.getWithParams("/chat/users/online-status",i)}catch(i){throw console.error("获取用户在线状态失败:",i),i}}static async getConnectionDetails(){try{return await b.get("/chat/admin/connections")}catch(n){throw console.error("获取连接详情失败:",n),n}}}const Ye={class:"min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-black"},Ze={class:"relative z-10"},et={class:"container mx-auto px-6 py-8"},tt={class:"glass-card-dark rounded-2xl p-8 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 animate-fade-in-up"},st={class:"flex items-center justify-between"},at={class:"flex items-center gap-4"},rt={class:"flex items-center gap-6"},nt={class:"flex items-center gap-2"},ot={class:"text-sm text-gray-300"},lt={class:"flex items-center gap-2"},it={class:"relative z-10"},ct={class:"container mx-auto px-6 py-4"},dt={class:"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 animate-fade-in-up"},ut={class:"flex flex-wrap items-center justify-between gap-4"},vt={class:"flex items-center gap-4"},mt={class:"flex items-center gap-2"},yt={class:"text-cyan-300"},gt={key:0,class:"flex items-center gap-2"},ht={class:"flex items-center gap-2"},ft={class:"flex items-center gap-2 text-sm text-gray-400"},xt={class:"flex items-center gap-2 text-sm text-gray-400"},pt={class:"flex items-center gap-2"},_t={class:"text-xs text-gray-400"},bt={class:"container mx-auto px-6 py-8 relative z-10"},wt={class:"grid grid-cols-1 xl:grid-cols-4 gap-6"},kt={class:"xl:col-span-1"},St={class:"glass-card-dark rounded-2xl border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 overflow-hidden animate-fade-in-left h-[750px] flex flex-col"},Ct={class:"px-6 py-4 border-b border-gray-700/50 bg-gray-800/30"},Nt={class:"flex items-center justify-between"},It={class:"text-xs text-gray-400"},Ut={key:0,class:"text-cyan-400 ml-2"},jt={class:"flex items-center gap-2"},Mt={class:"flex-1 overflow-y-auto"},At={key:0,class:"flex flex-col items-center justify-center h-full text-center p-8"},Ot={key:1,class:"p-4 space-y-3"},$t=["onClick"],Wt={key:0,class:"absolute top-3 left-3 w-3 h-3 bg-cyan-400 rounded-full animate-pulse shadow-lg"},Tt={key:1,class:"absolute top-3 right-3 min-w-[20px] h-5 bg-red-500 rounded-full flex items-center justify-center px-1"},zt={class:"text-xs text-white font-semibold"},Et={class:"flex items-center space-x-4"},Lt={class:"relative flex-shrink-0"},Dt=["src","alt"],Ht={key:1,class:"w-full h-full bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center"},Rt={class:"absolute -bottom-1 -right-1 w-5 h-5 bg-gray-800 rounded-full flex items-center justify-center border border-gray-700"},Pt={class:"flex-1 min-w-0"},Bt={class:"flex items-center justify-between mb-2"},Ft={class:"text-white font-semibold text-base truncate"},Jt={class:"text-xs text-gray-500 flex-shrink-0 ml-2"},Vt={class:"mb-2"},Kt={class:"text-sm text-gray-400 truncate leading-relaxed"},Gt={class:"flex items-center justify-between"},qt={class:"flex items-center space-x-2"},Qt={key:0,class:"flex items-center"},Xt={class:"flex mr-1"},Yt={class:"text-xs text-gray-500"},Zt={class:"flex items-center gap-1"},es={class:"xl:col-span-3"},ts={class:"glass-card-dark rounded-2xl border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 overflow-hidden animate-fade-in-right h-[750px] flex flex-col"},ss={class:"px-6 py-4 border-b border-gray-700/50 bg-gray-800/30"},as={class:"flex items-center justify-between"},rs={class:"flex items-center gap-4"},ns=["src","alt"],os={class:"text-xl font-semibold text-white flex items-center gap-2"},ls={key:0,class:"bi bi-patch-check-fill text-cyan-400 text-lg"},is={class:"text-sm text-gray-400 flex items-center gap-2"},cs={class:"flex items-center gap-3"},ds={class:"flex items-center gap-2 px-3 py-1 rounded-lg bg-gray-700/30"},us={class:"text-xs text-gray-400 font-medium"},vs={key:0,class:"text-center py-16"},ms={class:"text-2xl font-bold text-white mb-3"},ys={class:"text-gray-400 mb-8 text-lg leading-relaxed max-w-md mx-auto"},gs={class:"flex flex-wrap justify-center gap-3 max-w-2xl mx-auto"},hs=["onClick"],fs={key:1,class:"mb-6 animate-fade-in-up"},xs={class:"space-y-4"},ps={key:0,class:"flex items-start gap-3 max-w-[70%]"},_s={class:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden border border-gray-600/30"},bs=["src","alt"],ws={class:"bg-gray-700/50 border border-gray-600/30 rounded-2xl rounded-tl-sm p-3 text-white"},ks={class:"flex items-center gap-2 mt-1 ml-1"},Ss={class:"text-xs text-gray-500"},Cs={key:1,class:"flex items-start gap-3 max-w-[70%] flex-row-reverse"},Ns={class:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden border border-cyan-500/30"},Is=["src","alt"],Us={key:1,class:"w-full h-full bg-gradient-to-r from-cyan-600 to-blue-600 rounded-full flex items-center justify-center"},js={class:"text-right"},Ms={class:"bg-gradient-to-r from-cyan-600 to-blue-600 rounded-2xl rounded-tr-sm p-3 text-white"},As={class:"flex items-center gap-2 mt-1 justify-end mr-1"},Os={class:"text-xs text-gray-500"},$s={class:"text-xs text-cyan-400"},Ws={key:0,class:"flex justify-start mt-4"},Ts={class:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden border border-gray-600/30"},zs=["src","alt"],Es={key:1,class:"w-full h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center animate-pulse-gentle"},Ls={class:"flex items-center gap-2 mt-1 ml-1"},Ds={class:"text-xs text-green-400"},Hs={class:"px-6 py-4 border-t border-gray-700/50 bg-gray-800/20"},Rs={class:"flex items-center justify-between mb-3"},Ps={class:"flex items-center gap-3"},Bs={key:0,class:"text-xs text-gray-500"},Fs={class:"flex items-end gap-3"},Js={class:"flex-1 relative"},Vs=["onKeydown","disabled"],Ks={key:0,class:"absolute -top-6 left-2 text-xs text-cyan-400 bg-gray-800/80 px-2 py-1 rounded-lg"},Gs=["disabled"],qs={__name:"customer-service",setup(pe){const n=He(),i=C(!1),g=C(!1),j=C(new Map),I=C(0),M=C(""),w=C([]),k=C([]),H=C(),l=C(null),T=C({adminOnline:!1,adminCount:0,totalUsers:0,normalUserCount:0});let y=null,R=null;const _e=["你好，请问有什么可以帮助您的？","我想了解产品信息","订单相关问题","技术支持"],be=he(()=>n.isLoggedIn),S=he(()=>l.value?{name:l.value.displayName||l.value.user_nickname||l.value.user_name||`用户 #${l.value.user_id}`,avatar:l.value.avatar||l.value.user_avatar,status:l.value.isOnline?"在线 - 用户对话":"离线 - 用户对话",isCustomerService:!1,isOnline:l.value.isOnline,userId:l.value.user_id,sessionId:l.value.id}:{name:"xlCig 客服团队",avatar:null,status:T.value.adminOnline?"在线 - 平均响应时间 < 1分钟":"离线 - 我们会尽快回复您的消息",isCustomerService:!0});Qe({title:"在线客服 - xlCig",meta:[{name:"description",content:"专业的在线客服服务，为您提供实时帮助和支持"}]});const Y=()=>{if(!be.value||!n.token){console.error("用户未登录，无法连接WebSocket");return}try{const e=`wss://api.xlcig.cn/websocket?token=${n.token}`;console.log("正在连接WebSocket:",e),y=new WebSocket(e),y.onopen=()=>{console.log("WebSocket连接成功"),i.value=!0,ke(),setTimeout(()=>{y&&y.readyState===WebSocket.OPEN&&(y.send(JSON.stringify({type:"get_users_status",data:{}})),console.log("已请求获取用户在线状态"))},1e3)},y.onmessage=t=>{try{const r=JSON.parse(t.data);Se(r)}catch(r){console.error("解析WebSocket消息失败:",r)}},y.onclose=()=>{console.log("WebSocket连接关闭"),i.value=!1,Z(),setTimeout(()=>{console.log("尝试重新连接WebSocket..."),Y()},3e3)},y.onerror=t=>{console.error("WebSocket连接错误:",t),i.value=!1}}catch(e){console.error("创建WebSocket连接失败:",e)}},we=()=>{y&&(y.close(),y=null),Z(),i.value=!1},ke=()=>{R=Xe(()=>{y&&y.readyState===WebSocket.OPEN&&y.send(JSON.stringify({type:"ping"}))},3e4)},Z=()=>{R&&(clearInterval(R),R=null)},Se=e=>{var t,r,a,o,u,m,f,p,$,x,U,ue,ve,me,ye,ge;switch(console.log("收到WebSocket消息:",e),e.type){case"user_info":console.log("用户信息:",e.data),I.value=e.data.unreadCount||0,e.data.stats&&(T.value=e.data.stats);break;case"message":const q=e.isAdmin||((t=e.data)==null?void 0:t.isAdmin)||((r=e.data)==null?void 0:r.isCustomerService)||((a=e.data)==null?void 0:a.role)==="admin"||((o=e.data)==null?void 0:o.role)==="customer_service",W={...e,user_id:e.user_id||((u=e.data)==null?void 0:u.user_id)||((m=e.data)==null?void 0:m.userId),avatar:e.avatar||((f=e.data)==null?void 0:f.avatar),nickname:e.nickname||((p=e.data)==null?void 0:p.nickname)||(($=e.data)==null?void 0:$.userName),userName:e.userName||((x=e.data)==null?void 0:x.userName),isAdmin:q,message_type:e.message_type||(q?"customer_service":"user"),...q&&{senderId:((U=e.data)==null?void 0:U.userId)||e.userId||((ue=e.data)==null?void 0:ue.senderId),data:{...e.data,userId:((ve=e.data)==null?void 0:ve.userId)||e.userId,senderId:((me=e.data)==null?void 0:me.senderId)||((ye=e.data)==null?void 0:ye.userId)}}};if(console.log("处理后的消息:",W),l.value){const A=W.user_id||((ge=W.data)==null?void 0:ge.targetUserId);A===l.value.user_id?(w.value.push(W),E()):console.log("消息不属于当前选中用户，不显示:",A,"当前用户:",l.value.user_id)}else w.value.push(W),E();X(()=>{de()}),W.user_id&&Ee(W);break;case"typing":console.log("收到输入状态消息:",e.data),te(e.data,!0);break;case"stop_typing":console.log("收到停止输入消息:",e.data),te(e.data,!1);break;case"message_read":I.value=e.data.unreadCount||0;break;case"user_online":console.log("用户上线:",e.data),P(e.data.userId||e.data.user_id,!0,e.data);break;case"user_offline":console.log("用户下线:",e.data),P(e.data.userId||e.data.user_id,!1,e.data);break;case"user_status_update":if(console.log("用户状态更新:",e.data),e.data&&(e.data.userId||e.data.user_id)){const A=e.data.isOnline!==void 0?e.data.isOnline:!0;P(e.data.userId||e.data.user_id,A,e.data)}break;case"users_status_response":console.log("收到用户状态列表:",e.data),e.data&&Array.isArray(e.data.users)&&e.data.users.forEach(A=>{P(A.userId||A.user_id,A.isOnline,A)});break;case"error":console.error("WebSocket错误:",e.data);break}},ee=()=>{j.value.clear(),g.value=!1,console.log("已清除所有typing状态")},te=(e,t)=>{var o;const r=e.userId||e.user_id||e.senderId,a=e.targetUserId||e.target_user_id;console.log("处理输入状态:",{userId:r,targetUserId:a,isTyping:t,currentSession:(o=l.value)==null?void 0:o.user_id}),l.value?(r===l.value.user_id||a===l.value.user_id)&&(t?(j.value.set(r,{nickname:e.nickname||e.userName||"用户",avatar:e.avatar,timestamp:Date.now()}),t.value=!0,console.log(`用户 ${r} 开始输入`)):(j.value.delete(r),t.value=j.value.size>0,console.log(`用户 ${r} 停止输入`))):t?(j.value.set(r,{nickname:e.nickname||e.userName||"用户",avatar:e.avatar,timestamp:Date.now()}),t.value=!0,console.log(`用户 ${r} 开始输入（团队模式）`)):(j.value.delete(r),t.value=j.value.size>0,console.log(`用户 ${r} 停止输入（团队模式）`))},P=(e,t,r={})=>{if(!e)return;console.log(`更新用户 ${e} 在线状态:`,t,r);const a=k.value.findIndex(o=>o.user_id===e);if(a>=0){const o=k.value[a],u=o.isOnline;if(o.isOnline=t,r.userName&&r.userName!==o.user_name&&(o.user_name=r.userName,o.displayName=r.userName),r.nickname&&r.nickname!==o.user_nickname&&(o.user_nickname=r.nickname,o.displayName=r.nickname),r.avatar&&r.avatar!==o.avatar&&(o.avatar=r.avatar,o.user_avatar=r.avatar),u!==t){const m=o.displayName||o.user_nickname||o.user_name||`用户 #${e}`;console.log(`📱 ${m} ${t?"🟢 上线了":"🔴 下线了"}`)}console.log(`会话列表中用户 ${e} 状态已更新:`,o)}else t&&(console.log(`新用户 ${e} 上线，重新加载会话列表`),z());l.value&&l.value.user_id===e&&(l.value.isOnline=t,r.userName&&(l.value.user_name=r.userName),r.nickname&&(l.value.user_nickname=r.nickname),r.avatar&&(l.value.avatar=r.avatar,l.value.user_avatar=r.avatar),console.log(`当前选中用户 ${e} 状态已更新`,l.value))},Ce=e=>{const t=e.target;t.style.height="auto",t.style.height=Math.min(t.scrollHeight,128)+"px"},J=async()=>{var t,r,a,o,u,m,f,p,$;if(!M.value.trim())return;const e=M.value.trim();try{if(l.value){if(console.log("向用户发送消息:",l.value.user_id,e),(await O.sendMessage(e,l.value.user_id)).success){const U={id:Date.now(),user_id:l.value.user_id,senderId:(t=n.user)==null?void 0:t.id,message:e,message_type:"customer_service",isAdmin:!0,avatar:(r=n.user)==null?void 0:r.avatar,nickname:n.userDisplayName,userName:n.userDisplayName,timestamp:Date.now(),created_at:new Date().toISOString(),data:{userId:(a=n.user)==null?void 0:a.id,userName:n.userDisplayName,isAdmin:!0}};w.value.push(U),console.log("消息发送成功，已添加到本地显示")}}else{if(!i.value||!y){console.error("WebSocket未连接");return}const x={type:"message",data:{message:e,user_id:(o=n.user)==null?void 0:o.id,userId:(u=n.user)==null?void 0:u.id}};y.send(JSON.stringify(x));const U=(m=n.user)==null?void 0:m.avatar;w.value.push({...x,data:{...x.data,userId:(f=n.user)==null?void 0:f.id,userName:n.userDisplayName,isAdmin:!1,avatar:U},user_id:(p=n.user)==null?void 0:p.id,timestamp:Date.now(),isAdmin:!1,message_type:"user",avatar:U,nickname:(($=n.user)==null?void 0:$.nickname)||n.userDisplayName,userName:n.userDisplayName})}M.value="",X(()=>{const x=document.querySelector("textarea");x&&(x.style.height="48px")}),E(),se()}catch(x){console.error("发送消息失败:",x)}},Ne=e=>{M.value=e,J()},B=C(!1),Ie=()=>{var e,t,r,a,o,u,m;if(console.log("输入框获得焦点"),B.value=!0,!(!i.value||!y))try{y.send(JSON.stringify({type:"typing",data:{userId:(e=n.user)==null?void 0:e.id,userName:n.userDisplayName,nickname:((t=n.user)==null?void 0:t.nickname)||n.userDisplayName,avatar:(r=n.user)==null?void 0:r.avatar,targetUserId:(a=l.value)==null?void 0:a.user_id,chatMode:l.value?"user_conversation":"customer_service",isAdmin:((o=n.user)==null?void 0:o.role)==="admin",isCustomerService:((u=n.user)==null?void 0:u.role)==="admin"||((m=n.user)==null?void 0:m.role)==="customer_service"}}))}catch(f){console.error("发送输入状态失败:",f)}},Ue=()=>{console.log("输入框失去焦点"),B.value=!1,setTimeout(()=>{B.value||se()},500)},se=()=>{var e,t,r,a,o,u,m;if(!(!i.value||!y))try{y.send(JSON.stringify({type:"stop_typing",data:{userId:(e=n.user)==null?void 0:e.id,userName:n.userDisplayName,nickname:((t=n.user)==null?void 0:t.nickname)||n.userDisplayName,avatar:(r=n.user)==null?void 0:r.avatar,targetUserId:(a=l.value)==null?void 0:a.user_id,chatMode:l.value?"user_conversation":"customer_service",isAdmin:((o=n.user)==null?void 0:o.role)==="admin",isCustomerService:((u=n.user)==null?void 0:u.role)==="admin"||((m=n.user)==null?void 0:m.role)==="customer_service"}}))}catch(f){console.error("发送停止输入状态失败:",f)}},V=async()=>{try{const e=await O.getChatHistory({limit:50});e.success&&e.data&&(w.value=e.data.map(t=>{var o,u;console.log("历史消息:",t);const r=t.message_type==="customer_service"||t.role==="admin"||t.role==="customer_service",a={...t,user_id:t.user_id||t.id,isAdmin:r,avatar:t.avatar||t.user_avatar,nickname:t.nickname||t.user_nickname||t.username,userName:t.nickname||t.user_nickname||t.username,message_type:r?"customer_service":"user"};return console.log("处理后的历史消息:",a,{isCustomerService:r,userId:t.user_id,currentUserId:(o=n.user)==null?void 0:o.id,isCurrentUser:t.user_id===((u=n.user)==null?void 0:u.id)}),a}),console.log("所有处理后的历史消息:",w.value),E())}catch(e){console.error("加载聊天历史失败:",e)}},z=async()=>{try{const e=await O.getUserSessions({limit:20});e.success&&e.data&&(k.value=e.data.map(t=>{console.log("原始用户会话数据:",t);const r={...t,id:t.user_id,user_avatar:t.avatar,user_nickname:t.nickname,user_name:t.nickname||t.username,unread_count:t.unread_count||0,last_message:t.last_message,last_message_time:t.last_message_time,last_message_type:t.last_message_type,isOnline:t.isOnline||!1,displayName:t.displayName||t.nickname||t.username,status:"active"};return console.log("处理后的用户会话数据:",r),r}))}catch(e){console.error("加载用户会话列表失败:",e)}},je=async()=>{try{const e=await O.getServiceStatus();e.success&&(T.value=e.data)}catch(e){console.error("获取服务状态失败:",e)}},ae=async()=>{try{const e=await O.getUnreadCount();e.success&&(I.value=e.data.unreadCount)}catch(e){console.error("获取未读消息数量失败:",e)}},re=async()=>{try{const e=await O.markMessagesAsRead();e.success&&(I.value=e.data.unreadCount)}catch(e){console.error("标记消息已读失败:",e)}},E=()=>{X(()=>{H.value&&(H.value.scrollTop=H.value.scrollHeight)})},ne=e=>{var a,o,u,m,f,p;const t=(a=n.user)==null?void 0:a.id;if(e.message_type==="customer_service"||e.isAdmin){const $=e.senderId||((o=e.data)==null?void 0:o.userId)||((u=e.data)==null?void 0:u.senderId);if($)return $===t;const x=e.nickname||e.userName||((m=e.data)==null?void 0:m.userName),U=n.userDisplayName;if(x&&U)return x===U}return(e.user_id||((f=e.data)==null?void 0:f.user_id)||((p=e.data)==null?void 0:p.userId))===t},F=e=>{var t,r,a,o;return e.isAdmin===!0||e.message_type==="customer_service"||((t=e.data)==null?void 0:t.isAdmin)===!0||((r=e.data)==null?void 0:r.isCustomerService)===!0||((a=e.data)==null?void 0:a.role)==="admin"||((o=e.data)==null?void 0:o.role)==="customer_service"},K=e=>{if(!e)return"";const t=new Date(e),a=new Date-t,o=Math.floor(a/(1e3*60)),u=Math.floor(a/(1e3*60*60*24));return u===0?o<1?"刚刚":o<60?`${o}分钟前`:t.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"}):u===1?`昨天 ${t.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"})}`:u<7?`${["周日","周一","周二","周三","周四","周五","周六"][t.getDay()]} ${t.toLocaleTimeString("zh-CN",{hour12:!1,hour:"2-digit",minute:"2-digit"})}`:t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},Me=e=>{switch(e){case"active":return"bg-green-500/20 text-green-400 border-green-500/30";case"waiting":return"bg-yellow-500/20 text-yellow-400 border-yellow-500/30";case"closed":return"bg-gray-500/20 text-gray-400 border-gray-500/30";default:return"bg-gray-500/20 text-gray-400 border-gray-500/30"}},Ae=e=>{switch(e){case"active":return"进行中";case"waiting":return"等待中";case"closed":return"已结束";default:return"未知"}},oe=e=>{var r;const t=e.avatar||((r=e.data)==null?void 0:r.avatar);return t&&t.trim()&&t!=="null"&&t!=="undefined"?t.trim():null},Oe=e=>{var t,r;return e.nickname||((t=e.data)==null?void 0:t.nickname)||e.userName||((r=e.data)==null?void 0:r.userName)||"用户"},le=e=>{var r,a;const t=e.avatar||((r=e.data)==null?void 0:r.avatar)||((a=n.user)==null?void 0:a.avatar);return t&&t.trim()&&t!=="null"&&t!=="undefined"?t.trim():null},ie=e=>{var t,r;return e.nickname||((t=e.data)==null?void 0:t.nickname)||e.userName||((r=e.data)==null?void 0:r.userName)||n.userDisplayName},G=e=>{console.log("头像加载失败:",e.target.src),e.target.style.display="none"},ce=e=>{console.log("头像加载成功:",e.target.src)},de=async()=>{if(I.value>0)try{(await O.markMessagesAsRead()).success&&(I.value=0,console.log("消息已自动标记为已读"))}catch(e){console.error("自动标记消息已读失败:",e)}},$e=async e=>{console.log("选中用户会话:",e),ee(),l.value=e,await We(e.user_id),e.unread_count>0&&(await Te(e.user_id),e.unread_count=0)},We=async e=>{try{console.log("加载用户聊天记录:",e);const t=await O.getUserMessages(e,{limit:50});t.success&&t.data&&(w.value=t.data.map(r=>{console.log("用户消息:",r);const a=r.message_type==="customer_service"||r.role==="admin"||r.role==="customer_service"||r.is_admin_message===1;return{...r,user_id:r.user_id||r.id,isAdmin:a,avatar:r.avatar,nickname:r.nickname||r.username,userName:r.nickname||r.username,message_type:a?"customer_service":"user"}}),console.log("用户聊天记录加载完成:",w.value),E())}catch(t){console.error("加载用户聊天记录失败:",t),await V()}},Te=async e=>{try{(await O.markSessionAsRead(e)).success&&(console.log("会话已标记为已读:",e),await ae())}catch(t){console.error("标记会话已读失败:",t),await de()}},ze=()=>{console.log("返回客服模式"),ee(),l.value=null,V()},Ee=e=>{var a;const t=e.user_id,r=k.value.findIndex(o=>o.user_id===t);if(r>=0){const o=k.value[r];o.last_message=e.message||((a=e.data)==null?void 0:a.message),o.last_message_time=new Date().toISOString(),(!l.value||l.value.user_id!==t)&&e.message_type==="user"&&(o.unread_count=(o.unread_count||0)+1),k.value.splice(r,1),k.value.unshift(o)}else e.message_type==="user"&&z()};return Re(async()=>{if(!n.isLoggedIn){Pe("/auth/login");return}await Promise.all([je(),ae(),V(),z()]),Y()}),Be(()=>{we()}),(e,t)=>{const r=Le;return d(),c("div",Ye,[t[27]||(t[27]=s("div",{class:"fixed inset-0 pointer-events-none"},[s("div",{class:"absolute top-20 left-20 w-96 h-96 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-full filter blur-3xl animate-pulse"}),s("div",{class:"absolute bottom-20 right-20 w-80 h-80 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-full filter blur-3xl animate-pulse delay-1000"})],-1)),fe(r,{"show-back-button":!1,"show-nav-menu":!0,"show-breadcrumb":!0,"show-location":!1,"show-search-button":!1,"show-notification-button":!0,"show-decorations":!1,"current-page-title":"在线客服","logo-size":"medium"}),s("section",Ze,[s("div",et,[s("div",tt,[s("div",st,[t[5]||(t[5]=s("div",null,[s("h1",{class:"text-4xl font-bold text-white mb-3 flex items-center gap-3"},[s("i",{class:"bi bi-headset text-cyan-400 text-3xl animate-bounce-gentle"}),N(" 在线客服 ")]),s("p",{class:"text-gray-300 text-lg"},"专业的客服团队随时为您提供帮助")],-1)),s("div",at,[s("div",rt,[s("div",nt,[s("div",{class:h(["w-3 h-3 rounded-full animate-pulse",T.value.adminOnline?"bg-green-500":"bg-red-500"])},null,2),s("span",ot,v(T.value.adminOnline?"客服在线":"暂无客服在线"),1)])]),s("div",lt,[I.value>0?(d(),c("button",{key:0,onClick:re,class:"px-4 py-2 text-sm font-medium bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg transition-all duration-300 flex items-center gap-2 hover:scale-105 active:scale-95"},[t[3]||(t[3]=s("i",{class:"bi bi-check2-all"},null,-1)),N(" 标记已读 ("+v(I.value)+") ",1)])):_("",!0),s("button",{onClick:z,class:"px-4 py-2 text-sm font-medium border border-gray-600 hover:border-cyan-500 text-gray-300 hover:text-white rounded-lg transition-all duration-300 flex items-center gap-2 hover:scale-105 active:scale-95"},t[4]||(t[4]=[s("i",{class:"bi bi-arrow-clockwise"},null,-1),N(" 刷新 ")]))])])])])])]),s("section",it,[s("div",ct,[s("div",dt,[s("div",ut,[s("div",vt,[s("div",mt,[t[6]||(t[6]=s("i",{class:"bi bi-chat-dots text-cyan-400"},null,-1)),t[7]||(t[7]=s("span",{class:"text-white font-medium"},"当前模式：",-1)),s("span",yt,v(l.value?`与 ${l.value.user_nickname||l.value.user_name||"用户"} 对话`:"客服团队模式"),1)]),l.value?(d(),c("div",gt,t[8]||(t[8]=[s("div",{class:"w-2 h-2 rounded-full bg-green-500 animate-pulse"},null,-1),s("span",{class:"text-sm text-gray-400"},"用户对话中",-1)]))):_("",!0)]),s("div",ht,[s("div",ft,[t[9]||(t[9]=s("i",{class:"bi bi-people"},null,-1)),s("span",null,"会话: "+v(k.value.length),1)]),s("div",xt,[t[10]||(t[10]=s("i",{class:"bi bi-chat-left-dots"},null,-1)),s("span",null,"消息: "+v(w.value.length),1)]),s("div",pt,[s("div",{class:h(["w-2 h-2 rounded-full animate-pulse",i.value?"bg-green-500":"bg-red-500"])},null,2),s("span",_t,v(i.value?"已连接":"连接中..."),1)])])])])])]),s("main",bt,[s("div",wt,[s("div",kt,[s("div",St,[s("div",Ct,[s("div",Nt,[s("div",null,[t[11]||(t[11]=s("h3",{class:"text-lg font-semibold text-white mb-1 flex items-center gap-2"},[s("i",{class:"bi bi-chat-left-text text-cyan-400"}),N(" 对话列表 ")],-1)),s("p",It,[N(v(k.value.length)+" 个会话 ",1),l.value?(d(),c("span",Ut," · 已选中 "+v(l.value.user_nickname||l.value.user_name||`用户
                      #${l.value.user_id}`),1)):_("",!0)])]),s("div",jt,[l.value?(d(),c("button",{key:0,onClick:ze,class:"p-2 text-gray-400 hover:text-cyan-300 hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95",title:"返回客服模式"},t[12]||(t[12]=[s("i",{class:"bi bi-arrow-left text-lg"},null,-1)]))):_("",!0),s("button",{onClick:z,class:"p-2 text-gray-400 hover:text-cyan-300 hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95",title:"刷新列表"},t[13]||(t[13]=[s("i",{class:"bi bi-arrow-clockwise text-lg"},null,-1)]))])])]),s("div",Mt,[k.value.length===0?(d(),c("div",At,t[14]||(t[14]=[s("div",{class:"w-20 h-20 bg-gradient-to-br from-gray-700/50 to-gray-800/50 rounded-full flex items-center justify-center mb-6"},[s("i",{class:"bi bi-chat-dots text-3xl text-gray-500"})],-1),s("h4",{class:"text-xl font-semibold text-white mb-3"},"暂无对话",-1),s("p",{class:"text-gray-400 text-sm leading-relaxed"},[N("等待用户开始对话"),s("br"),N("或从客服团队模式开始")],-1)]))):(d(),c("div",Ot,[(d(!0),c(L,null,D(k.value,(a,o)=>{var u,m,f;return d(),c("div",{key:a.id,onClick:p=>$e(a),class:h(["relative p-4 rounded-xl cursor-pointer transition-all duration-300 group hover:scale-[1.01] animate-fade-in-up border border-transparent hover:border-gray-600/50",[((u=l.value)==null?void 0:u.id)===a.id?"session-selected border-cyan-500/50":"hover:bg-gray-800/30"]]),style:xe({animationDelay:`${o*50}ms`})},[((m=l.value)==null?void 0:m.id)===a.id?(d(),c("div",Wt)):_("",!0),a.unread_count>0?(d(),c("div",Tt,[s("span",zt,v(a.unread_count>99?"99+":a.unread_count),1)])):_("",!0),s("div",Et,[s("div",Lt,[s("div",{class:h(["w-14 h-14 rounded-xl overflow-hidden border-2 transition-all duration-300 shadow-lg",((f=l.value)==null?void 0:f.id)===a.id?"border-cyan-400/70 shadow-cyan-400/20":"border-gray-700/50"])},[a.user_avatar?(d(),c("img",{key:0,src:a.user_avatar,alt:a.user_nickname||"用户",class:"w-full h-full object-cover",onError:t[0]||(t[0]=p=>p.target.style.display="none")},null,40,Dt)):(d(),c("div",Ht,t[15]||(t[15]=[s("i",{class:"bi bi-person text-white text-xl"},null,-1)])))],2),s("div",Rt,[s("div",{class:h(["w-3 h-3 rounded-full",a.isOnline?"bg-green-500 animate-pulse":"bg-gray-500"])},null,2)])]),s("div",Pt,[s("div",Bt,[s("h4",Ft,v(a.user_nickname||a.user_name||`用户 #${a.user_id}`),1),s("span",Jt,v(K(a.last_message_time||a.started_at)),1)]),s("div",Vt,[s("p",Kt,v(a.last_message||"等待开始对话..."),1)]),s("div",Gt,[s("div",qt,[s("span",{class:h(["text-xs px-2 py-1 rounded-lg font-medium",Me(a.status)])},v(Ae(a.status)),3),a.rating?(d(),c("div",Qt,[s("div",Xt,[(d(),c(L,null,D(5,p=>s("i",{key:p,class:h([p<=a.rating?"text-yellow-400":"text-gray-600","bi bi-star-fill text-xs"])},null,2)),64))]),s("span",Yt,v(a.rating)+".0",1)])):_("",!0)]),s("div",Zt,[s("div",{class:h(["w-2 h-2 rounded-full",a.isOnline?"bg-green-500 animate-pulse":"bg-gray-500"])},null,2),s("span",{class:h(["text-xs",a.isOnline?"text-green-400":"text-gray-400"])},v(a.isOnline?"在线":"离线"),3)])])])])],14,$t)}),128))]))])])]),s("div",es,[s("div",ts,[s("div",ss,[s("div",as,[s("div",rs,[s("div",{class:h(["w-12 h-12 rounded-xl flex items-center justify-center overflow-hidden border-2 shadow-lg transition-all duration-300",S.value.isCustomerService?"border-cyan-500/50":"border-gray-600/50"])},[S.value.avatar?(d(),c("img",{key:0,src:S.value.avatar,alt:S.value.name,class:"w-full h-full object-cover",onError:G},null,40,ns)):(d(),c("div",{key:1,class:h(["w-full h-full flex items-center justify-center animate-pulse-gentle",S.value.isCustomerService?"bg-gradient-to-r from-cyan-500 to-blue-500":"bg-gradient-to-r from-gray-500 to-gray-600"])},[s("i",{class:h(["text-white text-xl",S.value.isCustomerService?"bi bi-headset":"bi bi-person"])},null,2)],2))],2),s("div",null,[s("h3",os,[N(v(S.value.name)+" ",1),S.value.isCustomerService?(d(),c("i",ls)):_("",!0)]),s("p",is,[s("div",{class:h(["w-2 h-2 rounded-full",S.value.isCustomerService?i.value?"bg-green-500 animate-pulse":"bg-gray-500":S.value.isOnline?"bg-green-500 animate-pulse":"bg-gray-500"])},null,2),N(" "+v(S.value.status),1)])])]),s("div",cs,[s("div",ds,[s("div",{class:h(["w-2 h-2 rounded-full animate-pulse",i.value?"bg-green-500":"bg-red-500"])},null,2),s("span",us,v(i.value?"已连接":"连接中..."),1)]),t[16]||(t[16]=Q('<div class="flex items-center gap-1" data-v-d3b9e81d><button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95" title="语音通话" data-v-d3b9e81d><i class="bi bi-telephone text-lg" data-v-d3b9e81d></i></button><button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95" title="更多选项" data-v-d3b9e81d><i class="bi bi-three-dots text-lg" data-v-d3b9e81d></i></button></div>',1))])])]),s("div",{class:"flex-1 overflow-y-auto p-6",ref_key:"messagesContainer",ref:H},[w.value.length===0?(d(),c("div",vs,[t[17]||(t[17]=s("div",{class:"w-24 h-24 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-2xl"},[s("i",{class:"bi bi-chat-heart text-4xl text-cyan-400"})],-1)),s("h3",ms,v(l.value?`与 ${l.value.user_nickname||l.value.user_name||`用户
                  #${l.value.user_id}`} 的对话`:"欢迎使用在线客服"),1),s("p",ys,v(l.value?"您正在与该用户进行私人对话，可以实时交流解决问题":"有任何问题都可以在这里与我们沟通，您也可以从左侧选择特定用户进行对话"),1),s("div",gs,[(d(),c(L,null,D(_e,(a,o)=>s("button",{key:a,onClick:u=>Ne(a),class:"px-6 py-3 bg-cyan-500/20 border border-cyan-400/30 text-cyan-300 rounded-xl text-sm font-medium hover:bg-cyan-500/30 hover:border-cyan-400/50 transition-all duration-300 hover:scale-105 active:scale-95 animate-fade-in-up shadow-lg hover:shadow-cyan-400/20",style:xe({animationDelay:`${o*100}ms`})},v(a),13,hs)),64))])])):_("",!0),!T.value.adminOnline&&w.value.length>0?(d(),c("div",fs,t[18]||(t[18]=[s("div",{class:"bg-yellow-500/10 border border-yellow-400/30 rounded-lg p-4 text-center transition-all duration-300 hover:bg-yellow-500/15 hover:border-yellow-400/50"},[s("i",{class:"bi bi-info-circle text-yellow-400 mr-2 animate-pulse"}),s("span",{class:"text-yellow-300 text-sm"},"当前暂无客服在线，您可以留言，我们会尽快回复您。")],-1)]))):_("",!0),s("div",xs,[fe(Je,{name:"message",tag:"div",class:"space-y-4"},{default:Fe(()=>[(d(!0),c(L,null,D(w.value,a=>{var o,u,m;return d(),c("div",{key:a.id||a.timestamp,class:h(["flex",ne(a)?"justify-end":"justify-start"])},[ne(a)?(d(),c("div",Cs,[s("div",Ns,[le(a)?(d(),c("img",{key:0,src:le(a),alt:ie(a),class:"w-full h-full object-cover",onError:G,onLoad:ce},null,40,Is)):(d(),c("div",Us,t[19]||(t[19]=[s("i",{class:"bi bi-person text-white text-sm"},null,-1)])))]),s("div",js,[s("div",Ms,v(a.message||((m=a.data)==null?void 0:m.message)),1),s("div",As,[s("span",Os,v(K(a.timestamp||a.created_at)),1),s("span",$s,v(ie(a)),1)])])])):(d(),c("div",ps,[s("div",_s,[oe(a)?(d(),c("img",{key:0,src:oe(a),alt:Oe(a),class:"w-full h-full object-cover",onError:G,onLoad:ce},null,40,bs)):(d(),c("div",{key:1,class:h(["w-full h-full rounded-full flex items-center justify-center",F(a)?"bg-gradient-to-r from-green-500 to-emerald-500":"bg-gradient-to-r from-gray-500 to-gray-600"])},[s("i",{class:h(["text-white text-sm",F(a)?"bi bi-person-badge":"bi bi-person"])},null,2)],2))]),s("div",null,[s("div",ws,v(a.message||((o=a.data)==null?void 0:o.message)),1),s("div",ks,[s("span",{class:h(["text-xs",F(a)?"text-green-400":"text-gray-400"])},v(a.nickname||((u=a.data)==null?void 0:u.nickname)||(F(a)?"客服":"用户")),3),s("span",Ss,v(K(a.timestamp||a.created_at)),1)])])]))],2)}),128))]),_:1}),g.value&&j.value.size>0?(d(),c("div",Ws,[(d(!0),c(L,null,D(j.value,([a,o])=>(d(),c("div",{key:a,class:"flex items-start gap-3 max-w-[70%] animate-fade-in-up mb-2"},[s("div",Ts,[o.avatar?(d(),c("img",{key:0,src:o.avatar,alt:o.nickname,class:"w-full h-full object-cover",onError:t[1]||(t[1]=u=>u.target.style.display="none")},null,40,zs)):(d(),c("div",Es,t[20]||(t[20]=[s("i",{class:"bi bi-person-badge text-white text-sm"},null,-1)])))]),s("div",null,[t[22]||(t[22]=Q('<div class="bg-gray-700/50 border border-gray-600/30 rounded-2xl rounded-tl-sm p-3" data-v-d3b9e81d><div class="flex gap-1" data-v-d3b9e81d><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" data-v-d3b9e81d></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.1s;" data-v-d3b9e81d></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.2s;" data-v-d3b9e81d></div></div></div>',1)),s("div",Ls,[s("span",Ds,v(o.nickname),1),t[21]||(t[21]=s("span",{class:"text-xs text-gray-500"},"正在输入...",-1))])])]))),128))])):_("",!0)])],512),s("div",Hs,[s("div",Rs,[t[25]||(t[25]=Q('<div class="flex items-center gap-2" data-v-d3b9e81d><button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95" title="附件" data-v-d3b9e81d><i class="bi bi-paperclip text-lg" data-v-d3b9e81d></i></button><button class="p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-300 hover:scale-110 active:scale-95" title="表情" data-v-d3b9e81d><i class="bi bi-emoji-smile text-lg" data-v-d3b9e81d></i></button></div>',1)),s("div",Ps,[t[24]||(t[24]=s("span",{class:"text-xs text-gray-500 flex items-center gap-1"},[s("i",{class:"bi bi-keyboard"}),N(" Enter 发送，Shift+Enter 换行 ")],-1)),M.value.length>0?(d(),c("div",Bs,v(M.value.length)+" 字符 ",1)):_("",!0),I.value>0?(d(),c("button",{key:1,onClick:re,class:"text-xs text-cyan-400 hover:text-cyan-300 transition-all duration-300 hover:scale-105 active:scale-95 px-3 py-1 rounded-lg hover:bg-cyan-500/10 border border-cyan-500/20"},[t[23]||(t[23]=s("i",{class:"bi bi-check2-all mr-1"},null,-1)),N(" 标记已读 ("+v(I.value)+") ",1)])):_("",!0)])]),s("div",Fs,[s("div",Js,[Ve(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=a=>M.value=a),onKeydown:Ge(qe(J,["exact","prevent"]),["enter"]),onInput:Ce,onFocus:Ie,onBlur:Ue,disabled:!i.value,placeholder:"输入您的消息... (Enter 发送，Shift+Enter 换行)",rows:"1",class:"w-full px-4 py-3 bg-gray-800/50 border border-gray-600/50 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-400 text-white placeholder-gray-400 transition-all duration-300 resize-none hover:border-cyan-500/50 focus:scale-[1.01] min-h-[48px] max-h-32 hide-scrollbar"},null,40,Vs),[[Ke,M.value]]),B.value?(d(),c("div",Ks," 正在输入... ")):_("",!0)]),s("button",{onClick:J,disabled:!M.value.trim()||!i.value,class:"px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-gray-600 disabled:to-gray-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 disabled:shadow-none flex items-center gap-2 hover:scale-105 active:scale-95 min-h-[48px] flex-shrink-0"},t[26]||(t[26]=[s("i",{class:"bi bi-send text-lg"},null,-1),s("span",{class:"hidden sm:inline"},"发送",-1)]),8,Gs)])])])])])])])}}},ra=De(qs,[["__scopeId","data-v-d3b9e81d"]]);export{ra as default};
