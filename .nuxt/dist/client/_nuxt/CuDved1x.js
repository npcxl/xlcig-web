import{_ as L}from"./C9iI_EUL.js";import{u as S}from"./B5gbdNuQ.js";import{_ as T,G as C,f as A,c as o,a as e,i as N,d as i,s as r,l as s,t as n,p as b,b as k,w as _,o as l}from"./D7rkgqT2.js";import"./CFjwhGiX.js";const U={class:"min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-black p-6"},D={class:"max-w-4xl mx-auto"},V={class:"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 mb-6"},B={class:"grid md:grid-cols-2 gap-4"},J={class:"p-4 bg-gray-800/30 rounded-lg"},W={class:"text-lg font-medium"},$={key:0,class:"text-green-400"},q={key:1,class:"text-red-400"},z={key:0,class:"p-4 bg-gray-800/30 rounded-lg"},O={class:"text-lg font-medium text-white"},E={class:"flex items-start gap-3"},G={key:0},H={key:1},M={key:0,class:"mt-3"},X={class:"glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 mb-6"},j={key:0,class:"text-center py-8"},F={key:1,class:"text-center py-8"},K={class:"text-red-400 text-lg mb-4"},Q={key:2,class:"space-y-4"},R={class:"grid md:grid-cols-2 gap-4"},Y={class:"p-4 bg-gray-800/30 rounded-lg"},Z={class:"text-lg font-mono text-cyan-400"},tt={class:"p-4 bg-gray-800/30 rounded-lg"},et={class:"text-lg text-white"},st={key:0,class:"grid md:grid-cols-3 gap-4"},it={key:0,class:"p-4 bg-gray-800/30 rounded-lg"},ot={class:"text-lg text-white"},lt={key:1,class:"p-4 bg-gray-800/30 rounded-lg"},at={class:"text-lg text-white"},dt={key:2,class:"p-4 bg-gray-800/30 rounded-lg"},nt={class:"text-lg font-mono text-white"},rt={class:"grid md:grid-cols-2 gap-4"},ft={class:"p-4 bg-gray-800/30 rounded-lg"},bt={class:"text-lg"},gt={key:0,class:"text-green-400"},ct={key:1,class:"text-cyan-400"},vt={key:0,class:"p-4 bg-gray-800/30 rounded-lg"},xt={class:"text-lg"},mt={key:0,class:"text-green-400"},ut={key:1,class:"text-yellow-400"},pt={class:"flex gap-4 pt-4"},yt=["disabled"],kt=["disabled"],_t={class:"mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg"},wt={class:"text-blue-300 text-sm"},ht={__name:"location-test",setup(It){const f=C(),{loading:g,data:a,error:v,fetchLocation:c,refreshLocation:x,getLocationText:w,isUserLocationUpdated:h,isUserLoggedIn:d}=S();A(()=>{f.initializeAuth(),c(!1)});const I=()=>{const m={id:999,username:"test_user",nickname:"测试用户",email:"test@example.com",role:"user",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};f.setAuth("test_token_for_demo",m),setTimeout(()=>{c(!0,!0)},500)},P=()=>{f.logout(),setTimeout(()=>{c(!0,!0)},500)};return(m,t)=>{var p;const u=L;return l(),o("div",U,[e("div",D,[t[35]||(t[35]=e("div",{class:"text-center mb-8"},[e("h1",{class:"text-4xl font-bold text-white mb-4"},"🌍 IP位置定位测试"),e("p",{class:"text-gray-300 text-lg"},"测试首页IP获取、用户登录检测、高德API调用等完整流程")],-1)),e("div",V,[t[10]||(t[10]=e("h2",{class:"text-2xl font-semibold text-white mb-4 flex items-center"},[e("i",{class:"bi bi-person-check mr-3 text-cyan-400"}),i(" 用户登录状态检查 ")],-1)),e("div",B,[e("div",J,[t[5]||(t[5]=e("div",{class:"text-sm text-gray-400 mb-1"},"前端登录检查",-1)),e("div",W,[s(d)?(l(),o("span",$,t[3]||(t[3]=[e("i",{class:"bi bi-check-circle mr-2"},null,-1),i("已登录 (前端验证) ")]))):(l(),o("span",q,t[4]||(t[4]=[e("i",{class:"bi bi-x-circle mr-2"},null,-1),i("未登录 (前端验证) ")])))])]),s(d)?(l(),o("div",z,[t[6]||(t[6]=e("div",{class:"text-sm text-gray-400 mb-1"},"用户信息",-1)),e("div",O,n(s(f).userDisplayName)+" (ID: "+n((p=s(f).user)==null?void 0:p.id)+") ",1)])):r("",!0)]),e("div",{class:b(["mt-4 p-4 rounded-lg",s(d)?"bg-green-500/10 border border-green-500/30":"bg-yellow-500/10 border border-yellow-500/30"])},[e("div",E,[e("i",{class:b(["bi bi-info-circle text-lg mt-0.5",s(d)?"text-green-400":"text-yellow-400"])},null,2),e("div",null,[e("div",{class:b(["font-medium mb-2",s(d)?"text-green-300":"text-yellow-300"])},n(s(d)?"完整功能模式":"基础功能模式"),3),e("div",{class:b(["text-sm",s(d)?"text-green-200":"text-yellow-200"])},[s(d)?(l(),o("div",G,t[7]||(t[7]=[i(" ✅ 前端已确认登录状态"),e("br",null,null,-1),i(" ✅ API调用时会携带认证token"),e("br",null,null,-1),i(" ✅ 后端会更新users表的loginIp和loginIpContent字段"),e("br",null,null,-1),i(" ✅ 可以查看个人登录历史记录 ")]))):(l(),o("div",H,t[8]||(t[8]=[i(" ℹ️ 仍可获取IP地址和位置信息"),e("br",null,null,-1),i(" ℹ️ 数据会保存到ip_addresses表作为缓存"),e("br",null,null,-1),i(" ⚠️ 不会更新个人用户档案"),e("br",null,null,-1),i(" 💡 请登录以启用完整功能 ")])))],2),s(d)?r("",!0):(l(),o("div",M,[k(u,{to:"/auth/login",class:"px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm transition-colors"},{default:_(()=>t[9]||(t[9]=[i(" 立即登录 ")])),_:1,__:[9]})]))])])],2)]),e("div",X,[t[34]||(t[34]=e("h2",{class:"text-2xl font-semibold text-white mb-4 flex items-center"},[e("i",{class:"bi bi-geo-alt mr-3 text-cyan-400"}),i(" IP位置信息 ")],-1)),s(g)?(l(),o("div",j,t[11]||(t[11]=[e("div",{class:"w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"},null,-1),e("p",{class:"text-white text-lg"},"正在获取IP位置信息...",-1)]))):s(v)?(l(),o("div",F,[t[13]||(t[13]=e("div",{class:"text-red-400 text-6xl mb-4"},[e("i",{class:"bi bi-exclamation-triangle"})],-1)),e("p",K,n(s(v)),1),e("button",{onClick:t[0]||(t[0]=y=>s(x)(!0)),class:"px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"},t[12]||(t[12]=[e("i",{class:"bi bi-arrow-clockwise mr-2"},null,-1),i(" 重新获取 ")]))])):s(a)?(l(),o("div",Q,[e("div",R,[e("div",Y,[t[14]||(t[14]=e("div",{class:"text-sm text-gray-400 mb-1"},"IP地址",-1)),e("div",Z,n(s(a).ip),1)]),e("div",tt,[t[15]||(t[15]=e("div",{class:"text-sm text-gray-400 mb-1"},"位置",-1)),e("div",et,n(s(w)()),1)])]),s(a).location&&!s(a).location.error?(l(),o("div",st,[s(a).location.province?(l(),o("div",it,[t[16]||(t[16]=e("div",{class:"text-sm text-gray-400 mb-1"},"省份",-1)),e("div",ot,n(s(a).location.province),1)])):r("",!0),s(a).location.city?(l(),o("div",lt,[t[17]||(t[17]=e("div",{class:"text-sm text-gray-400 mb-1"},"城市",-1)),e("div",at,n(s(a).location.city),1)])):r("",!0),s(a).location.adcode?(l(),o("div",dt,[t[18]||(t[18]=e("div",{class:"text-sm text-gray-400 mb-1"},"区域编码",-1)),e("div",nt,n(s(a).location.adcode),1)])):r("",!0)])):r("",!0),e("div",rt,[e("div",ft,[t[21]||(t[21]=e("div",{class:"text-sm text-gray-400 mb-1"},"数据来源",-1)),e("div",bt,[s(a).cached?(l(),o("span",gt,t[19]||(t[19]=[e("i",{class:"bi bi-database mr-2"},null,-1),i("数据库缓存 ")]))):(l(),o("span",ct,t[20]||(t[20]=[e("i",{class:"bi bi-cloud mr-2"},null,-1),i("高德地图API ")])))])]),s(f).isLoggedIn?(l(),o("div",vt,[t[24]||(t[24]=e("div",{class:"text-sm text-gray-400 mb-1"},"登录信息更新",-1)),e("div",xt,[s(h)?(l(),o("span",mt,t[22]||(t[22]=[e("i",{class:"bi bi-check-circle mr-2"},null,-1),i("已更新到数据库 ")]))):(l(),o("span",ut,t[23]||(t[23]=[e("i",{class:"bi bi-clock mr-2"},null,-1),i("未更新 ")])))])])):r("",!0)]),e("div",pt,[e("button",{onClick:t[1]||(t[1]=y=>s(x)(!0)),disabled:s(g),class:"px-6 py-3 bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50 text-white rounded-lg transition-colors"},[e("i",{class:b(["bi bi-arrow-clockwise mr-2",{"animate-spin":s(g)}])},null,2),t[25]||(t[25]=i(" 强制刷新 "))],8,yt),e("button",{onClick:t[2]||(t[2]=y=>s(c)(!0)),disabled:s(g),class:"px-6 py-3 bg-gray-600 hover:bg-gray-700 disabled:opacity-50 text-white rounded-lg transition-colors"},t[26]||(t[26]=[e("i",{class:"bi bi-geo-alt mr-2"},null,-1),i(" 重新定位 ")]),8,kt),s(d)?(l(),o("button",{key:1,onClick:P,class:"px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"},t[28]||(t[28]=[e("i",{class:"bi bi-box-arrow-right mr-2"},null,-1),i(" 测试登出 ")]))):(l(),o("button",{key:0,onClick:I,class:"px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"},t[27]||(t[27]=[e("i",{class:"bi bi-person-plus mr-2"},null,-1),i(" 测试登录 ")])))]),e("div",_t,[e("div",wt,[t[30]||(t[30]=e("i",{class:"bi bi-info-circle mr-2"},null,-1)),t[31]||(t[31]=e("strong",null,"测试说明：",-1)),t[32]||(t[32]=i('"测试登录"仅用于演示前端登录状态检查，使用模拟token。 要测试完整的数据库更新功能，请使用真实账号')),k(u,{to:"/auth/login",class:"text-blue-400 underline ml-1"},{default:_(()=>t[29]||(t[29]=[i("登录")])),_:1,__:[29]}),t[33]||(t[33]=i("。 "))])])])):r("",!0)]),t[36]||(t[36]=N('<div class="glass-card-dark rounded-2xl p-6 border border-cyan-500/30 shadow-2xl shadow-cyan-500/20" data-v-77fffe4b><h2 class="text-2xl font-semibold text-white mb-4 flex items-center" data-v-77fffe4b><i class="bi bi-info-circle mr-3 text-cyan-400" data-v-77fffe4b></i> 功能说明 </h2><div class="space-y-4 text-gray-300" data-v-77fffe4b><div class="p-4 bg-gray-800/30 rounded-lg" data-v-77fffe4b><h3 class="text-lg font-semibold text-white mb-2" data-v-77fffe4b>✅ 已实现的功能</h3><ul class="space-y-2 text-sm" data-v-77fffe4b><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>前端登录状态检查</strong>：检查localStorage中的认证信息</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>真实IP获取</strong>：使用ipinfo.io获取公网IP，避免代理问题</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>高德地图API调用</strong>：获取IP对应的省市地址信息</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>后端JWT验证</strong>：确保只有真实登录用户才能更新数据库</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>用户表更新</strong>：自动更新loginIp和loginIpContent字段</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>前端实时显示</strong>：显示位置信息和数据库更新状态</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>智能缓存机制</strong>：24小时内重复IP使用数据库缓存</li><li data-v-77fffe4b><i class="bi bi-check text-green-400 mr-2" data-v-77fffe4b></i><strong data-v-77fffe4b>双重安全保障</strong>：前端UX检查 + 后端安全验证</li></ul></div><div class="p-4 bg-gray-800/30 rounded-lg" data-v-77fffe4b><h3 class="text-lg font-semibold text-white mb-2" data-v-77fffe4b>🔄 工作流程</h3><ol class="space-y-2 text-sm list-decimal list-inside" data-v-77fffe4b><li data-v-77fffe4b><strong data-v-77fffe4b>前端登录检查</strong>：首页加载时检查用户登录状态(localStorage)</li><li data-v-77fffe4b><strong data-v-77fffe4b>获取真实IP</strong>：HeaderLocation组件调用ipinfo.io获取公网IP</li><li data-v-77fffe4b><strong data-v-77fffe4b>API调用</strong>：前端调用/api/amap/ip/接口（携带认证token）</li><li data-v-77fffe4b><strong data-v-77fffe4b>后端验证</strong>：后端验证JWT token确认用户身份</li><li data-v-77fffe4b><strong data-v-77fffe4b>位置查询</strong>：检查数据库缓存或调用高德地图API获取省市信息</li><li data-v-77fffe4b><strong data-v-77fffe4b>数据库更新</strong>：如果用户已登录且验证通过，更新用户表</li><li data-v-77fffe4b><strong data-v-77fffe4b>前端显示</strong>：显示位置信息和更新状态</li></ol></div><div class="p-4 bg-gray-800/30 rounded-lg" data-v-77fffe4b><h3 class="text-lg font-semibold text-white mb-2" data-v-77fffe4b>🎯 登录状态判断逻辑</h3><div class="space-y-3 text-sm" data-v-77fffe4b><div class="p-3 bg-cyan-500/10 rounded-lg border border-cyan-500/20" data-v-77fffe4b><div class="font-medium text-cyan-300 mb-1" data-v-77fffe4b>📱 前端判断（用户体验）</div><div class="text-cyan-200" data-v-77fffe4b> • 检查localStorage中的authToken和userInfo<br data-v-77fffe4b> • 提供即时的登录状态反馈<br data-v-77fffe4b> • 决定是否显示&quot;登录信息已更新&quot;等提示 </div></div><div class="p-3 bg-purple-500/10 rounded-lg border border-purple-500/20" data-v-77fffe4b><div class="font-medium text-purple-300 mb-1" data-v-77fffe4b>🔒 后端验证（安全保证）</div><div class="text-purple-200" data-v-77fffe4b> • 验证JWT token的有效性和完整性<br data-v-77fffe4b> • 确保只有真正登录的用户才能更新数据库<br data-v-77fffe4b> • 防止恶意请求和数据篡改 </div></div></div></div></div></div>',1))])])}}},Ct=T(ht,[["__scopeId","data-v-77fffe4b"]]);export{Ct as default};
