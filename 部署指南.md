# 电脑装机指南项目部署指南

## 📋 系统要求

### 基础环境
- **Docker**: 20.0+ (推荐使用 Docker Desktop)
- **Docker Compose**: 2.0+
- **操作系统**: Linux/Windows/macOS
- **内存**: 最低 1GB，推荐 2GB+
- **存储**: 最低 1GB 可用空间

## 🚀 **推荐部署方式：Docker容器化部署**

这是最简单、最可靠的部署方式，适用于生产环境。

### Linux/macOS 部署
```bash
# 克隆项目23
git clone <your-repo-url>
cd computer-installation-guide

# 执行Docker部署脚本
chmod +x docker-build.sh
./docker-build.sh
```

### Windows 部署
```powershell
# 克隆项目
git clone <your-repo-url>
cd computer-installation-guide

# 执行Docker部署脚本
PowerShell -ExecutionPolicy Bypass -File docker-build.ps1
```

### 手动 Docker 部署
```bash
# 1. 停止现有容器
docker-compose -f docker-compose.prod.yml down

# 2. 构建并启动
docker-compose -f docker-compose.prod.yml up --build -d

# 3. 查看状态
docker-compose -f docker-compose.prod.yml ps
```

## 🤖 **自动化部署方案**

### 1. 自动更新部署脚本

**无需手动git拉取，自动检查更新并部署！**

#### Linux/macOS 自动部署
```bash
# 设置执行权限
chmod +x auto-deploy.sh

# 检查更新并自动部署
./auto-deploy.sh

# 强制重新部署
./auto-deploy.sh --force

# 部署指定分支
./auto-deploy.sh --branch develop

# 指定项目目录
./auto-deploy.sh --dir /path/to/project
```

#### Windows 自动部署
```powershell
# 检查更新并自动部署
PowerShell -ExecutionPolicy Bypass -File auto-deploy.ps1

# 强制重新部署
PowerShell -ExecutionPolicy Bypass -File auto-deploy.ps1 -Force

# 部署指定分支
PowerShell -ExecutionPolicy Bypass -File auto-deploy.ps1 -Branch develop

# 指定项目目录
PowerShell -ExecutionPolicy Bypass -File auto-deploy.ps1 -ProjectDir "C:\path\to\project"
```

**功能特性：**
- ✅ 自动检查Git更新
- ✅ 智能跳过无更新的部署
- ✅ 自动备份和回滚机制
- ✅ 完整的健康检查
- ✅ 详细的日志记录

### 2. Webhook 触发部署

**通过HTTP请求远程触发部署！**

#### 启动Webhook服务
```bash
# 设置执行权限
chmod +x webhook-deploy.sh

# 启动webhook服务（前台）
./webhook-deploy.sh

# 后台运行
./webhook-deploy.sh --daemon

# 自定义端口和令牌
./webhook-deploy.sh --port 8080 --token "your-secret-token"

# 生成systemd服务
sudo ./webhook-deploy.sh --systemd
```

#### 触发部署
```bash
# 触发main分支部署
curl -X POST "http://your-server:9000/deploy?token=your-webhook-secret-token"

# 触发指定分支部署
curl -X POST "http://your-server:9000/deploy?token=your-webhook-secret-token&branch=develop"

# 查看服务状态
curl "http://your-server:9000/status"

# 健康检查
curl "http://your-server:9000/health"
```

**Webhook API端点：**
- `POST /deploy?token=TOKEN&branch=BRANCH` - 触发部署
- `GET /status` - 查看状态
- `GET /health` - 健康检查

### 3. 定时自动检查部署

**定时检查代码更新，完全无人值守！**

```bash
# 设置执行权限
chmod +x schedule-deploy.sh

# 启动定时检查服务（每5分钟检查一次）
./schedule-deploy.sh --start

# 自定义检查间隔（每10分钟）
./schedule-deploy.sh --start --interval 600

# 查看服务状态
./schedule-deploy.sh --status

# 停止服务
./schedule-deploy.sh --stop

# 重启服务
./schedule-deploy.sh --restart

# 查看日志
tail -f schedule-deploy.log
```

#### 使用Crontab（替代方案）
```bash
# 生成crontab配置
./schedule-deploy.sh --crontab

# 手动添加到crontab（每5分钟检查一次）
echo "*/5 * * * * cd $(pwd) && ./schedule-deploy.sh --check-once >> schedule-deploy.log 2>&1" | crontab -

# 查看当前crontab
crontab -l
```

## 🔧 生产环境配置

### 1. 域名配置

当前配置的域名：`www.xl-tool.online`

相关配置文件：
- `nginx.conf` - Web服务器配置
- `docker-compose.prod.yml` - 容器环境变量

### 2. Nginx 配置特性

已配置的功能：
- 静态文件服务
- Gzip 压缩
- 缓存策略
- 错误页面处理
- 安全头设置

## 🌐 域名和SSL配置

### 1. 域名绑定
确保DNS记录正确配置：
```bash
# 检查DNS解析
nslookup www.xl-tool.online
dig www.xl-tool.online
```

需要添加的DNS记录：
- **A记录**: `www.xl-tool.online` → 您的服务器IP
- **A记录**: `xl-tool.online` → 您的服务器IP (可选)

### 2. SSL 证书配置（可选）
```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 停止容器获取证书
docker-compose -f docker-compose.prod.yml down

# 获取证书
sudo certbot certonly --standalone -d www.xl-tool.online -d xl-tool.online

# 证书路径：/etc/letsencrypt/live/www.xl-tool.online/
```

## 📊 监控和管理

### 1. 容器管理
```bash
# 查看容器状态
docker-compose -f docker-compose.prod.yml ps

# 查看实时日志
docker-compose -f docker-compose.prod.yml logs -f

# 重启服务
docker-compose -f docker-compose.prod.yml restart

# 停止服务
docker-compose -f docker-compose.prod.yml down
```

### 2. 自动化脚本管理
```bash
# 查看自动部署状态
./schedule-deploy.sh --status

# 查看webhook服务状态
curl http://localhost:9000/status

# 查看所有相关进程
ps aux | grep -E "(auto-deploy|webhook|schedule)"

# 查看日志文件
ls -la *.log
```

### 3. 系统监控
```bash
# 查看系统资源
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 4. 日志管理
```bash
# 查看nginx访问日志
docker-compose -f docker-compose.prod.yml exec pc-guide-frontend tail -f /var/log/nginx/access.log

# 查看nginx错误日志
docker-compose -f docker-compose.prod.yml exec pc-guide-frontend tail -f /var/log/nginx/error.log

# 查看自动部署日志
tail -f auto-deploy.log

# 查看定时部署日志
tail -f schedule-deploy.log

# 查看webhook日志
tail -f webhook-deploy.log
```

## 🔒 安全配置

### 1. 防火墙设置
```bash
# Ubuntu/Debian
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS (如果使用SSL)
sudo ufw allow 9000  # Webhook端口 (可选)
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=9000/tcp  # Webhook端口
sudo firewall-cmd --reload
```

### 2. Webhook安全
```bash
# 修改webhook密钥
sed -i 's/your-webhook-secret-token/your-new-complex-token/g' webhook-deploy.sh

# 限制访问IP（在nginx中配置）
# allow 192.168.1.0/24;
# deny all;
```

### 3. Docker安全
```bash
# 定期清理无用镜像
docker system prune -f

# 更新镜像
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

## 🔄 更新和维护

### 1. 代码更新
```bash
# 使用自动部署脚本（推荐）
./auto-deploy.sh

# 或使用定时检查服务
./schedule-deploy.sh --check-once

# 或通过webhook触发
curl -X POST "http://localhost:9000/deploy?token=your-token"
```

### 2. 定期维护
```bash
# 定时清理Docker资源
echo "0 3 * * 0 docker system prune -f" | crontab -

# 定时检查服务状态
echo "0 */6 * * * ./schedule-deploy.sh --status" | crontab -
```

## 🛠️ 故障排除

### 常见问题

#### 1. 端口冲突
```bash
# 查看端口占用
netstat -tlnp | grep 80
# 或
lsof -i :80

# 停止占用进程
sudo fuser -k 80/tcp
```

#### 2. 容器启动失败
```bash
# 查看详细日志
docker-compose -f docker-compose.prod.yml logs

# 重建容器
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up --build -d
```

#### 3. 自动部署失败
```bash
# 查看自动部署日志
tail -f auto-deploy.log

# 手动检查Git状态
git status
git fetch origin main

# 检查Docker状态
docker ps
docker-compose -f docker-compose.prod.yml ps
```

#### 4. Webhook服务无响应
```bash
# 检查webhook进程
ps aux | grep webhook

# 检查端口占用
netstat -tlnp | grep 9000

# 重启webhook服务
pkill -f webhook-deploy.sh
./webhook-deploy.sh --daemon
```

#### 5. 域名无法访问
```bash
# 检查DNS解析
nslookup www.xl-tool.online

# 检查容器状态
docker-compose -f docker-compose.prod.yml ps

# 检查nginx配置
docker-compose -f docker-compose.prod.yml exec pc-guide-frontend nginx -t
```

#### 6. 磁盘空间不足
```bash
# 清理Docker资源
docker system prune -a

# 清理日志
sudo journalctl --vacuum-time=7d

# 清理备份文件
find ./backups -type d -mtime +30 -exec rm -rf {} \;
```

## 📝 部署文件说明

### 核心部署文件
- ✅ `docker-build.sh/ps1` - **生产环境Docker部署脚本**
- ✅ `docker-compose.prod.yml` - 生产环境Docker配置
- ✅ `nginx.conf` - Web服务器配置  
- ✅ `Dockerfile.frontend` - 前端镜像构建

### 🔥 自动化部署文件（新增）
- ✅ `auto-deploy.sh/ps1` - **自动更新部署脚本**
- ✅ `webhook-deploy.sh` - **Webhook触发部署脚本**
- ✅ `schedule-deploy.sh` - **定时检查部署脚本**

### 访问地址
- **本地访问**: http://localhost
- **域名访问**: http://www.xl-tool.online (需要DNS配置)
- **HTTPS访问**: https://www.xl-tool.online (需要SSL证书)
- **Webhook API**: http://your-server:9000/deploy?token=your-token

## 📞 技术支持

如果遇到部署问题：

1. 查看容器日志：`docker-compose -f docker-compose.prod.yml logs -f`
2. 检查容器状态：`docker-compose -f docker-compose.prod.yml ps`
3. 验证配置文件：`docker-compose -f docker-compose.prod.yml config`
4. 重新构建镜像：`docker-compose -f docker-compose.prod.yml build --no-cache`
5. 查看自动化脚本日志：`tail -f *.log`

## �� 版本信息

- **当前版本**: 1.0.0
- **域名**: www.xl-tool.online
- **部署方式**: Docker容器化 + 自动化部署
- **最后更新**: 2024年12月

---

## 🎯 **快速开始（三种方式任选其一）**

### 方式一：一键部署（推荐新用户）
```bash
./docker-build.sh
```

### 方式二：自动化部署（推荐日常使用）
```bash
./auto-deploy.sh
```

### 方式三：完全自动化（推荐生产环境）
```bash
# 启动定时检查服务
./schedule-deploy.sh --start

# 或启动webhook服务
./webhook-deploy.sh --daemon
```


# 一次性更新所有配置文件
sed -i 's/www\.xl-tool\.online/xia.7788soft.com/g' nginx.conf docker-compose.prod.yml auto-deploy.sh webhook-deploy.sh auto-deploy.ps1

# 重新部署
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up --build -d

# 验证配置
echo "=== nginx.conf ==="
grep server_name nginx.conf
echo "=== docker-compose.prod.yml ==="
grep NGINX_HOST docker-compose.prod.yml

# 停止现有容器并重新构建部署
docker-compose -f docker-compose.prod.yml down && docker-compose -f docker-compose.prod.yml up --build -d

# 查看结果
docker ps && curl http://localhost