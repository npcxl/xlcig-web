import{r as T,g as A}from"./PvcLXTJB.js";import{aq as C}from"./4kkTLsQ6.js";import{u as F}from"./XW005Led.js";import{r as S,l as k,h as m,j as $,R as B}from"./-_uPjKn3.js";const{message:l,notification:L,dialog:D,loadingBar:R}=C(["message","notification","dialog","loadingBar"]),j=()=>({success:(t,a=3e3)=>{l.success(t,{duration:a})},error:(t,a=4e3)=>{l.error(t,{duration:a})},warning:(t,a=3e3)=>{l.warning(t,{duration:a})},info:(t,a=3e3)=>{l.info(t,{duration:a})},loading:t=>l.loading(t,{duration:0}),confirm:(t,a="确认")=>new Promise(o=>{D.warning({title:a,content:t,positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{o(!0)},onNegativeClick:()=>{o(!1)},onClose:()=>{o(!1)}})}),notify:{success:(t,a,o=4e3)=>{L.success({title:t,content:a,duration:o})},error:(t,a,o=4e3)=>{L.error({title:t,content:a,duration:o})},warning:(t,a,o=4e3)=>{L.warning({title:t,content:a,duration:o})},info:(t,a,o=4e3)=>{L.info({title:t,content:a,duration:o})}},loadingBar:R}),E=()=>{const{success:h,error:w,warning:d}=j(),u=F(),e=S({loading:!1,data:null,error:null,lastUpdated:null}),f=k(!1),g=async(r=!1,n=!1)=>{if(e.loading)return e.data;e.loading=!0,e.error=null;try{const s=u.isLoggedIn;r&&!s&&d("请先登录以启用完整的IP定位功能");const i=n?await T():await A();if(i.success&&i.data){if(e.data=i.data,e.lastUpdated=new Date,r){const{location:p,user:c}=i.data;if(p.error)d("IP定位失败: "+p.error);else{const y=`${p.province||"未知地区"} ${p.city||""}`,I=i.data.cached?"(缓存)":"";s&&(c!=null&&c.locationUpdated)?h(`定位成功: ${y}${I}，登录信息已更新`):s&&!(c!=null&&c.locationUpdated)?d(`定位成功: ${y}${I}，但登录信息未更新`):h(`定位成功: ${y}${I}（未登录状态）`)}}}else e.error=i.message||"获取定位信息失败",r&&w(e.error);return e.data}catch(s){return e.error=s.message||"网络错误",r&&w("获取定位信息失败"),console.error("IP定位错误:",s),null}finally{e.loading=!1}},t=async()=>f.value?e.data:(f.value=!0,u.initializeAuth(),await g(!1,!1)),a=async(r=!0)=>await g(r,!0),o=()=>{var n;if(!((n=e.data)!=null&&n.location))return"未知位置";const{location:r}=e.data;return r.error?"定位失败":`${r.province||"未知"} ${r.city||""}`},U=m(()=>{var r;return!!((r=e.data)!=null&&r.location&&!e.data.location.error)}),v=m(()=>{var r,n;return!!((n=(r=e.data)==null?void 0:r.user)!=null&&n.locationUpdated)}),x=m(()=>{var r;return((r=e.data)==null?void 0:r.ip)||"未知"}),P=m(()=>u.isLoggedIn);return{...B(e),hasAutoFetched:$(f),fetchLocation:g,autoFetchLocation:t,refreshLocation:a,getLocationText:o,hasLocation:U,isUserLocationUpdated:v,currentIp:x,isUserLoggedIn:P,locationState:$(e)}};export{E as u};
